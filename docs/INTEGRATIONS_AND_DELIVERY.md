# Alert Integrations and Delivery

This document describes the alert delivery system in OpsConductor-Pulse.

## Overview

When alerts are generated by the evaluator, they can be automatically delivered to customer-configured destinations. The delivery system supports multiple output types with tenant isolation and retry logic.

## Supported Delivery Types

### Webhook (Implemented)
HTTP POST with JSON payload to customer-specified URLs.

**Features**:
- JSON payload with alert details
- Automatic retry with exponential backoff
- SSRF protection (blocks internal IPs in PROD mode)
- Custom headers support
- Timeout configuration

### SNMP Trap (Implemented)
SNMP trap delivery to network management systems.

**Features**:
- SNMPv2c (community string authentication)
- SNMPv3 (username + auth/priv passwords)
- Custom OID prefix support
- Address validation (blocks internal networks)

### Email (Implemented)
SMTP email delivery to customer-specified addresses.

**Features**:
- TLS/STARTTLS support
- Authentication (username/password)
- Multiple recipients (to, cc, bcc)
- HTML and plain text formats
- Customizable subject and body templates
- Template variables: {severity}, {alert_type}, {device_id}, {message}, {timestamp}

## Database Schema

### integrations
Stores customer integration configurations.

```sql
CREATE TABLE integrations (
    integration_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id VARCHAR(64) NOT NULL,
    name VARCHAR(128) NOT NULL,
    type VARCHAR(16) NOT NULL DEFAULT 'webhook',  -- 'webhook', 'snmp', or 'email'
    enabled BOOLEAN NOT NULL DEFAULT true,

    -- Webhook fields
    config_json JSONB,  -- {"url": "...", "headers": {...}}

    -- SNMP fields
    snmp_host VARCHAR(255),
    snmp_port INTEGER DEFAULT 162,
    snmp_config JSONB,  -- {"version": "2c", "community": "..."} or v3 config
    snmp_oid_prefix VARCHAR(128) DEFAULT '1.3.6.1.4.1.99999',

    -- Email fields
    email_config JSONB,
    email_recipients JSONB,
    email_template JSONB,

    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);
```

### integration_routes
Rules for matching alerts to integrations.

```sql
CREATE TABLE integration_routes (
    route_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id VARCHAR(64) NOT NULL,
    integration_id UUID NOT NULL REFERENCES integrations(integration_id),

    -- Matching criteria
    alert_types TEXT[],      -- e.g., ['NO_HEARTBEAT', 'LOW_BATTERY']
    severities TEXT[],       -- e.g., ['CRITICAL', 'WARNING']
    min_severity INTEGER,    -- Minimum severity level (1-5)
    site_ids TEXT[],         -- Filter by site
    device_prefixes TEXT[],  -- Filter by device ID prefix

    -- Delivery trigger
    deliver_on TEXT[] DEFAULT ARRAY['OPEN'],  -- When to deliver

    priority INTEGER DEFAULT 0,
    enabled BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);
```

### delivery_jobs
Queue of pending and completed delivery attempts.

```sql
CREATE TABLE delivery_jobs (
    job_id BIGSERIAL PRIMARY KEY,
    tenant_id VARCHAR(64) NOT NULL,
    alert_id BIGINT NOT NULL,
    integration_id UUID NOT NULL,
    route_id UUID NOT NULL,

    deliver_on_event VARCHAR(16) NOT NULL,  -- 'OPEN' or 'CLOSED'
    status VARCHAR(16) NOT NULL DEFAULT 'PENDING',  -- PENDING, PROCESSING, COMPLETED, FAILED
    attempts INTEGER DEFAULT 0,
    next_run_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    last_error TEXT,
    payload_json JSONB NOT NULL,

    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,

    UNIQUE(tenant_id, alert_id, route_id, deliver_on_event)
);
```

### delivery_attempts
History of individual delivery attempts.

```sql
CREATE TABLE delivery_attempts (
    attempt_id BIGSERIAL PRIMARY KEY,
    tenant_id VARCHAR(64) NOT NULL,
    job_id BIGINT NOT NULL,
    attempt_no INTEGER NOT NULL,

    ok BOOLEAN NOT NULL,
    http_status INTEGER,  -- NULL for SNMP
    latency_ms INTEGER,
    error TEXT,

    started_at TIMESTAMPTZ NOT NULL,
    finished_at TIMESTAMPTZ NOT NULL
);
```

## Delivery Pipeline

```
fleet_alert (new OPEN alert)
         │
         ▼
    dispatcher
         │
         ├── fetch_open_alerts() - Get recent OPEN alerts
         │
         ├── fetch_routes(tenant_id) - Get enabled routes for tenant
         │
         ├── route_matches(alert, route) - Check if alert matches route criteria
         │
         └── INSERT delivery_job - Create job if no duplicate exists
                  │
                  ▼
         delivery_worker
                  │
                  ├── fetch_jobs() - Get PENDING jobs, mark PROCESSING
                  │
                  ├── fetch_integration() - Get integration config
                  │
                  ├── deliver_webhook() OR deliver_snmp() - Send alert
                  │
                  ├── record_attempt() - Log attempt details
                  │
                  └── update_job_status() - COMPLETED, FAILED, or retry
```

## Retry Logic

Failed deliveries are retried with exponential backoff:

| Attempt | Delay |
|---------|-------|
| 1 | Immediate |
| 2 | 30 seconds |
| 3 | 2 minutes |
| 4 | 8 minutes |
| 5 | 30 minutes |

After 5 failed attempts, the job is marked as FAILED.

**Backoff formula**: `min(base * 2^(attempt-1), max_delay)`
- Base delay: 30 seconds
- Maximum delay: 2 hours

## Payload Formats

### Webhook JSON Payload

```json
{
  "alert_id": 12345,
  "site_id": "lab-1",
  "device_id": "sensor-001",
  "alert_type": "NO_HEARTBEAT",
  "severity": 4,
  "confidence": 0.9,
  "summary": "lab-1: sensor-001 heartbeat missing/stale",
  "status": "OPEN",
  "created_at": "2024-01-01T12:00:00+00:00",
  "details": {
    "last_heartbeat_at": "2024-01-01T11:25:00+00:00"
  }
}
```

### SNMP Trap Varbinds

OID prefix is configurable (default: `1.3.6.1.4.1.99999`).

| OID | Type | Value |
|-----|------|-------|
| {prefix}.1.1.0 | OctetString | alert_id |
| {prefix}.1.2.0 | OctetString | device_id |
| {prefix}.1.3.0 | OctetString | tenant_id |
| {prefix}.1.4.0 | Integer | severity (1=critical, 2=warning, 3=info) |
| {prefix}.1.5.0 | OctetString | message/summary |
| {prefix}.1.6.0 | OctetString | timestamp (ISO 8601) |

Trap OID: `{prefix}.0.1`

### Email Configuration (email_config)
```json
{
  "smtp_host": "smtp.example.com",
  "smtp_port": 587,
  "smtp_user": "user@example.com",
  "smtp_password": "...",
  "smtp_tls": true,
  "from_address": "alerts@example.com",
  "from_name": "OpsConductor Alerts"
}
```

### Email Recipients (email_recipients)
```json
{
  "to": ["admin@example.com", "oncall@example.com"],
  "cc": ["manager@example.com"],
  "bcc": []
}
```

### Email Template (email_template)
```json
{
  "subject_template": "[{severity}] {alert_type}: {device_id}",
  "body_template": "Custom HTML or text...",
  "format": "html"
}
```

## Security

### Tenant Isolation
- All tables include `tenant_id` column
- RLS policies enforce tenant boundaries
- Customers can only see/manage their own integrations

### SSRF Prevention
Webhook URLs and SNMP hosts are validated to block:
- Private IP ranges (10.x, 172.16.x, 192.168.x)
- Loopback addresses (127.x, localhost)
- Link-local addresses (169.254.x)
- Cloud metadata endpoints (169.254.169.254)

In PROD mode, webhooks also require HTTPS.

### Rate Limits
- Test delivery: 5 per minute per tenant
- Worker concurrency: 10 parallel jobs
- Per-integration rate limits available via configuration

## Configuration

### Environment Variables (delivery_worker)

| Variable | Default | Description |
|----------|---------|-------------|
| `MODE` | DEV | DEV or PROD (affects SSRF checks) |
| `WORKER_POLL_SECONDS` | 2 | How often to check for new jobs |
| `WORKER_BATCH_SIZE` | 10 | Jobs to process per cycle |
| `WORKER_TIMEOUT_SECONDS` | 30 | HTTP/SNMP timeout |
| `WORKER_MAX_ATTEMPTS` | 5 | Max retry attempts |
| `WORKER_BACKOFF_BASE_SECONDS` | 30 | Initial retry delay |
| `WORKER_BACKOFF_MAX_SECONDS` | 7200 | Maximum retry delay |

### Environment Variables (dispatcher)

| Variable | Default | Description |
|----------|---------|-------------|
| `DISPATCH_POLL_SECONDS` | 5 | How often to check for new alerts |
| `ALERT_LOOKBACK_MINUTES` | 30 | How far back to look for alerts |
| `ALERT_LIMIT` | 200 | Max alerts per dispatch cycle |
| `ROUTE_LIMIT` | 500 | Max routes to evaluate per tenant |

## Customer API

Customers manage integrations via the `/customer/*` API endpoints:

### Webhook Integrations
- `GET /customer/integrations` - List webhook integrations
- `POST /customer/integrations` - Create webhook integration
- `PATCH /customer/integrations/{id}` - Update webhook integration
- `DELETE /customer/integrations/{id}` - Delete webhook integration
- `POST /customer/integrations/{id}/test` - Send test delivery

### SNMP Integrations
- `GET /customer/integrations/snmp` - List SNMP integrations
- `POST /customer/integrations/snmp` - Create SNMP integration
- `PATCH /customer/integrations/snmp/{id}` - Update SNMP integration
- `DELETE /customer/integrations/snmp/{id}` - Delete SNMP integration
- `POST /customer/integrations/snmp/{id}/test` - Send test trap

### Email Integrations
- `GET /customer/integrations/email` - List email integrations
- `POST /customer/integrations/email` - Create email integration
- `GET /customer/integrations/email/{id}` - Get email integration
- `PATCH /customer/integrations/email/{id}` - Update email integration
- `DELETE /customer/integrations/email/{id}` - Delete email integration
- `POST /customer/integrations/email/{id}/test` - Send test email

### Integration Routes
- `GET /customer/integration-routes` - List routes
- `POST /customer/integration-routes` - Create route
- `PATCH /customer/integration-routes/{id}` - Update route
- `DELETE /customer/integration-routes/{id}` - Delete route

## Future Enhancements

- **Custom protocol adapters**: Plugin system for new output types
- **External secret management**: HashiCorp Vault integration
- **Delivery analytics**: Dashboard for delivery metrics and trends
- **SMS delivery**: Text message alerts for critical issues
