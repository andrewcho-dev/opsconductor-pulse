flowchart TD
    %% â”€â”€ External Actors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph ACTORS["External Actors"]
        direction LR
        DEV["ðŸ”Œ IoT Devices\nSensors Â· Gateways\nEdge Devices"]
        BROWSER["ðŸ–¥ï¸ Browser\nCustomers & Operators\nReact SPA"]
        EXTNOTIFY["ðŸ“£ Notification Endpoints\nSlack Â· PagerDuty\nTeams Â· Webhooks\nSNMP Â· Email Â· MQTT"]
    end

    %% â”€â”€ Edge & Identity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph EDGE["Edge & Identity Layer"]
        direction LR
        CADDY["ðŸ”€ Caddy\nTLS Reverse Proxy\n:80 â†’ :443\nPath-based routing"]
        KC["ðŸ”‘ Keycloak\nOIDC Identity Provider\nRealm: pulse\nJWT Â· PKCE"]
        MQTT["ðŸ“¡ Mosquitto\nMQTT Broker\n:1883 TCP\n:9001 WebSocket"]
    end

    %% â”€â”€ Ingestion â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph INGEST_LAYER["Ingestion Layer"]
        INGEST["âš¡ ingest\nMQTT + HTTP pipeline\nAuth cache Â· Rate limit\nBatch writes ~20k msg/s\nQuarantine invalid"]
    end

    %% â”€â”€ Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph DATA["Data Layer"]
        direction LR
        TSDB["ðŸ“Š TimescaleDB\ntelemetry hypertable\n90-day retention\n7-day compression\n~20k writes/sec"]
        PG["ðŸ˜ PostgreSQL\ndevice_state Â· alerts\nescalation_policies\nnotification_channels\noncall_schedules\nsubscriptions Â· tenants\nreport_runs"]
        PGB["ðŸ”„ PgBouncer\nConnection Pooler"]
    end

    %% â”€â”€ Evaluation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph EVAL["Evaluation Layer"]
        EVALUATOR["âš–ï¸ evaluator\nState tracking\nNO_HEARTBEAT alerts\nTHRESHOLD alerts\nAlert deduplication"]
    end

    %% â”€â”€ Alert Operations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph ALERTOPS["Alert Operations Layer"]
        direction LR
        ESC["ðŸªœ Escalation Engine\nescalation_worker\n60s tick\nMulti-level policies\nOn-call resolution"]
        ONCALL["ðŸ“… On-Call Resolver\nRotation layers\nOverride windows\nTimezone-aware"]
        NOTIF["ðŸ“¨ Notification Router\nSlack Â· PagerDuty\nTeams Â· HTTP\nSeverity filter\nThrottle"]
        LEGACY["ðŸ“¦ Legacy Pipeline\ndispatcher\ndelivery_worker\nWebhook Â· SNMP\nEmail Â· MQTT\n5-retry backoff"]
    end

    %% â”€â”€ Platform API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph API["Platform API Layer  (ui service â€” FastAPI + asyncpg)"]
        direction TB
        APIV2["/api/v2/*\nREST + WebSocket\nJWT Â· RLS\nTelemetry queries\nLive streaming"]
        CUSTAPI["/customer/*\nDevices Â· Alerts\nEscalation Â· Notifications\nOn-Call Â· Reports\nSubscriptions"]
        OPAPI["/operator/*\nCross-tenant views\nSystem health\nAudit log\nBYPASSRLS"]
        WORKERS["Background Workers\nescalation_worker 60s\nreport_worker daily\nmetrics_collector 5s"]
    end

    %% â”€â”€ Operator NOC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph NOC["Operator NOC Dashboard"]
        direction LR
        GAUGES["ðŸ“ˆ GaugeRow\nFleet online %\nIngest rate\nOpen alerts\nDB connections"]
        CHARTS["ðŸ“‰ MetricsChartGrid\n4 area charts\nmsg/s Â· alert rate\ndevice state Â· jobs"]
        HEATMAP["ðŸ—“ï¸ Alert Heatmap\nDay Ã— Hour volume\nECharts calendar"]
        FEED["ðŸ“Ÿ Live Event Feed\nScrolling stream\nPause control\nTV mode (F key)"]
        MATRIX["ðŸ¢ Tenant Matrix\nHealth per tenant\nSparklines\nAlert counts"]
    end

    %% â”€â”€ Platform Services â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    subgraph SVCPLATFORM["Platform Services"]
        direction LR
        PROVAPI["ðŸ­ provision_api\n:8081\nX-Admin-Key\nDevice registration\nActivation codes"]
        SUBWORKER["ðŸ’³ subscription_worker\nTRIALâ†’ACTIVE\nGRACEâ†’SUSPENDED\nDevice limits"]
        OPSWORKER["ðŸ©º ops_worker\nHealth polling\nsystem_metrics\nNOC data source"]
    end

    %% â”€â”€ Connections â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    %% Devices â†’ edge
    DEV -- "MQTT :1883" --> MQTT
    DEV -- "HTTP POST" --> CADDY

    %% Browser â†’ edge
    BROWSER -- "HTTPS :443" --> CADDY

    %% Caddy routing
    CADDY -- "/realms/* /admin/*" --> KC
    CADDY -- "/app/* /api/* /customer/* /operator/*" --> APIV2
    CADDY -- "/ingest/*" --> INGEST

    %% MQTT â†’ ingest
    MQTT --> INGEST

    %% Ingest â†’ data
    INGEST -- "batch writes" --> TSDB
    INGEST -- "quarantine" --> PG

    %% PgBouncer
    PGB --> PG
    PGB --> TSDB

    %% Evaluation
    TSDB --> EVALUATOR
    EVALUATOR -- "device_state" --> PG
    EVALUATOR -- "alerts" --> PG

    %% Alert ops
    PG -- "OPEN alerts" --> ESC
    ESC --> ONCALL
    ESC --> NOTIF
    PG --> LEGACY

    %% Notifications out
    NOTIF --> EXTNOTIFY
    LEGACY --> EXTNOTIFY

    %% API layer â†” data
    APIV2 --> PGB
    CUSTAPI --> PGB
    OPAPI --> PGB
    WORKERS --> PGB

    %% NOC reads from API
    OPAPI --> GAUGES
    OPAPI --> CHARTS
    OPAPI --> HEATMAP
    OPAPI --> FEED
    OPAPI --> MATRIX

    %% Platform services â†’ data
    PROVAPI --> PG
    SUBWORKER --> PG
    OPSWORKER -- "system_metrics" --> TSDB

    %% Keycloak â†” API
    KC -- "JWKS validation" --> APIV2

    %% Styling
    classDef actor fill:#1a1a2e,stroke:#e94560,color:#eee
    classDef infra fill:#16213e,stroke:#0f3460,color:#eee
    classDef data fill:#0f3460,stroke:#533483,color:#eee
    classDef api fill:#533483,stroke:#e94560,color:#eee
    classDef alert fill:#e94560,stroke:#ff6b6b,color:#fff
    classDef noc fill:#1a472a,stroke:#2d6a4f,color:#eee
    classDef svc fill:#2d3748,stroke:#4a5568,color:#eee

    class DEV,BROWSER,EXTNOTIFY actor
    class CADDY,KC,MQTT,INGEST,PGB infra
    class TSDB,PG data
    class EVALUATOR alert
    class ESC,ONCALL,NOTIF,LEGACY alert
    class APIV2,CUSTAPI,OPAPI,WORKERS api
    class GAUGES,CHARTS,HEATMAP,FEED,MATRIX noc
    class PROVAPI,SUBWORKER,OPSWORKER svc
