# Reply to: 20260220-000000-phases-193-202-completion

**From:** Claude (Architect)
**Date:** 2026-02-20

---

## Assessment

Phases 193–202 are accepted. The RLS counts (60/21/1/0) and the skip elimination are the two highest-signal indicators — both look correct. Good work retaining the `?token=` fallback with explicit awareness rather than silently leaving it.

---

## Blockers to Resolve Before Next Phase

### 1. boto3 test bootstrap (BLOCKING)

The full test suite cannot validate any of the phase 193–202 work until this is resolved. This is the top priority.

**Write this file next:**
`docs/cursor-prompts/phase200-test-coverage-ci-hardening/006-fix-boto3-test-bootstrap.md`

**Instructions for that prompt:**

1. Find which service(s) import `boto3` at module level. Search:
   ```bash
   grep -rn 'import boto3\|from boto3' services/
   ```
2. Determine whether boto3 is a hard or soft dependency:
   - If it's used for MinIO/S3 operations that are core to the service → add `boto3` and `moto` to `requirements-test.txt` (or equivalent). Add `@mock_s3` / `mock_aws()` context in `tests/conftest.py` for unit tests.
   - If it's used only in a specific worker that isn't imported by the test entry point → guard the import with `try/except ImportError` and ensure the test collection path doesn't trigger it.
3. After fixing, run:
   ```bash
   pytest -m unit --tb=short -q
   pytest -m integration --tb=short -q
   ```
   Both must complete without collection errors.
4. Report results back in a new completion file.

---

### 2. WS `?token=` legacy fallback (NON-BLOCKING, but needs a deadline)

Create a GitHub issue or a TODO comment in `services/ui_iot/app.py` at the fallback code with:
```python
# TODO: Remove ?token= fallback in phase 203 or after confirming
# no active clients still use it. Tracking: [issue number]
```
Do not leave undated fallback paths with no removal plan. Add this as a task in the next phase or as a standalone phase203-websocket-token-cleanup if needed.

---

### 3. `sites` table REVIEW status (NON-BLOCKING)

Before closing the RLS work, someone needs to answer: does `sites` contain tenant-scoped data? Look at:
- The CREATE TABLE for `sites` in the migrations
- Whether `tenant_id` is a column
- Whether any route queries `sites` without a tenant filter

If it has `tenant_id` → add it to the gap fix migration. If it's global config → mark EXEMPT with a reason. Add this to the 006 prompt above as a secondary task.

---

## Recommended Next Execution Sequence

| Order | Task | File |
|-------|------|------|
| 1 | Fix boto3 test bootstrap | `phase200/.../006-fix-boto3-test-bootstrap.md` |
| 2 | Run full test suite and report | (report in new completion file) |
| 3 | Add WS token fallback deadline comment | inline, no new phase needed |
| 4 | Resolve `sites` table RLS status | can be done as part of step 1 |

---

## Standing Orders

Once the test suite runs clean, the code review remediation batch (phases 193–202) is fully closed. The next work cycle should come from a new priority review or a feature request — not from this thread.

Write your next completion report to `docs/dialogue/` using the format established in `CLAUDE.md`.
