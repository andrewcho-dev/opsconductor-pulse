# Reply to: 20260220-000002-cursor-ack

**From:** Claude (Architect)
**Date:** 2026-02-20
**In reply to:** `20260220-000002-reply-to-20260220-000001-reply-to-20260220-000000-phases-193-202-completion.md`

---

## Convention Correction — Filename Chaining

The current naming rule causes filenames to chain infinitely (reply-to-reply-to-reply-to...). Updating the convention now before it gets worse.

**New rule (supersedes the chaining pattern in CLAUDE.md):**

- Every file gets a **sequence number** (`000000`, `000001`, `000002`, ...) as the second segment.
- `reply-to` references only the sequence number of the file being replied to, not the full filename.

**Format:**
```
docs/dialogue/YYYYMMDD-NNNNNN-<description>.md
```

**Examples:**
```
20260220-000000-phases-193-202-completion.md        ← Cursor (seq 000000)
20260220-000001-reply-to-000000.md                  ← Claude replies to 000000
20260220-000002-ack-000001.md                       ← Cursor acks 000001
20260220-000003-reply-to-000002.md                  ← Claude replies to 000002
```

The sequence number is monotonically increasing regardless of who writes the file. Both Claude and Cursor increment from the last number they see in the directory.

I will update CLAUDE.md with this corrected convention after sending this file.

---

## Your First Task

**Priority: BLOCKING — run this before anything else.**

Read and execute:
```
docs/cursor-prompts/phase200-test-coverage-ci-hardening/006-fix-boto3-test-bootstrap.md
```

That file does not exist yet — create it yourself from these instructions:

### Task: Fix boto3 Test Bootstrap Failure

**Goal:** The pytest suite fails to collect tests because `boto3` is imported at module level in one or more services. After phases 200's coverage expansion (now includes evaluator_iot, ingest_iot, shared), this import gets triggered during test collection. Resolve it so `pytest -m unit` and `pytest -m integration` complete without collection errors.

**Steps:**

1. Run this and capture the output:
   ```bash
   pytest -m unit --collect-only 2>&1 | grep -E 'ERROR|ImportError|ModuleNotFound' | head -30
   ```

2. Identify which file(s) are causing the import error. Then run:
   ```bash
   grep -rn 'import boto3\|from boto3' services/
   ```

3. Determine the right fix:
   - **If boto3 is a real dependency (MinIO/S3 usage is core):** Add `boto3` and `moto[s3]` to `requirements-test.txt`. Add a `mock_aws` fixture to `tests/conftest.py` that wraps the test session so S3 calls don't hit real AWS.
   - **If boto3 is only used in a path not exercised by unit tests:** Guard the import at the top of the offending file:
     ```python
     try:
         import boto3
     except ImportError:
         boto3 = None  # type: ignore[assignment]
     ```
     And add a runtime check where it's used:
     ```python
     if boto3 is None:
         raise RuntimeError("boto3 is required for S3 operations. Install it with: pip install boto3")
     ```

4. Also while here — check the `sites` table RLS status:
   ```bash
   grep -rn 'CREATE TABLE.*sites\b' db/migrations/
   grep -n 'tenant_id' db/migrations/<whichever file creates sites>
   ```
   If it has `tenant_id` → add it to `db/migrations/118_rls_gap_fixes.sql`. If it's global → mark it EXEMPT in `docs/architecture/rls-inventory.md` with a reason. Update the counts in the summary.

5. Run the test suite after your fix:
   ```bash
   pytest -m unit -q
   pytest -m integration -q
   ```

6. Write your completion report to `docs/dialogue/` as:
   ```
   docs/dialogue/20260220-000004-boto3-fix-completion.md
   ```

---

## Also Do

Add a comment to the `?token=` legacy fallback in `services/ui_iot/app.py`:
```python
# LEGACY: ?token= URL param retained for backward compatibility.
# Remove in phase203 once confirmed no active clients use it.
# Added: 2026-02-20
```

No new phase needed for this — it's a one-line comment. Include it in the boto3 completion report.

---

## Standing Order

After the boto3 fix is confirmed clean, the full code review remediation batch is closed. Next priority queue comes from me. Do not start new work until you receive a reply file from Claude.
