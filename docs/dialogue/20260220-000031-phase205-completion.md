# Phase 205 Completion Report

**From:** Cursor Agent  
**Date:** 2026-02-20  
**Sequence:** 000031  
**Phase:** 205 — Stripe Webhook Security Audit

---

## Task 1 — Audit and findings (before fixes)

Read in full:
- `services/ui_iot/routes/billing.py`
- `services/ui_iot/services/stripe_service.py`
- `services/subscription_worker/worker.py`
- `services/subscription_worker/email_templates.py`
- `services/subscription_worker/__init__.py`
- migration search for `stripe_events`

Findings file written:
- `docs/cursor-prompts/phase205-stripe-webhook-security/001-findings.md`

Key findings:
- Signature verification existed and used raw request body.
- **Idempotency store was missing** (no `stripe_events` table or checks in repo).
- Event handling had explicit type branches and ignored unknown types.
- Re-fetch from Stripe existed for some flows, but not for `customer.subscription.updated`.
- No card/payment details in logs, but email identifiers were logged in Keycloak provisioning path.

---

## Task 2 — Signature verification hardening

Updated `services/ui_iot/routes/billing.py` webhook handler:
- Explicitly requires `stripe-signature` header (`400` if missing).
- Uses specific exception handling:
  - `stripe.error.SignatureVerificationError` -> `400 Invalid signature`
  - parse errors -> `400 Invalid payload`
- Keeps raw payload verification flow via `construct_webhook_event(payload, sig_header)`.

---

## Task 3 — Idempotency via `stripe_events`

Added migration:
- `db/migrations/119_stripe_webhook_idempotency.sql`
  - creates `stripe_events(event_id PK, event_type, received_at, processed_at, payload_summary)`
  - adds index on `(event_type, received_at DESC)`

Webhook idempotency added in `billing.py`:
- Before business logic:
  - checks `SELECT 1 FROM stripe_events WHERE event_id = $1`
  - if exists, logs skip and returns `{"status":"ok"}`
  - inserts new event with `ON CONFLICT DO NOTHING`
- Stores only sanitized summary (`id`, `type`, `object_id`, `object_type`) — not full raw payload.
- Marks `processed_at` after processing attempt.

---

## Task 4 — Event allowlist + transition hardening

Updated `billing.py`:
- Added explicit `HANDLED_EVENT_TYPES` allowlist:
  - `checkout.session.completed`
  - `customer.subscription.updated`
  - `customer.subscription.deleted`
  - `invoice.payment_failed`
  - `invoice.payment_succeeded`
  - `invoice.paid`
- Unknown types are acknowledged and ignored.
- Re-fetches authoritative Stripe subscription in `_handle_subscription_updated(...)`.
- Added transition validator (`_can_transition`) and blocked invalid transitions in:
  - `_handle_subscription_updated`
  - `_handle_subscription_deleted`
  - `_handle_invoice_paid`
- Reduced sensitive logging in Keycloak provisioning (removed admin email from logs).

---

## Task 5 — Documentation updates

Updated:
- `docs/operations/security.md`
  - added phase `205`
  - added Stripe webhook security model section (signature verification, idempotency, allowlist, re-fetch)
- `docs/features/billing.md`
  - `last-verified: 2026-02-20`
  - added phase `205`
  - added webhook security model section

---

## Verification outputs

Executed checks:

```bash
rg 'construct_event|webhook_secret|stripe-signature|construct_webhook_event' services/ui_iot/routes/billing.py
rg 'stripe_events|event_id|already processed' services/ui_iot/routes/billing.py
rg 'logger.*card|logger.*payment_method|logger.*customer' services/ui_iot/routes/billing.py
rg 'stripe_events' db/migrations/119_stripe_webhook_idempotency.sql
```

Results (key lines):

```text
services/ui_iot/routes/billing.py
  sig_header = request.headers.get("stripe-signature")
  raise HTTPException(400, "Missing stripe-signature header")
  event = construct_webhook_event(payload, sig_header)

services/ui_iot/routes/billing.py
  SELECT 1 FROM stripe_events WHERE event_id = $1
  Stripe event already processed, skipping
  INSERT INTO stripe_events (event_id, event_type, received_at, payload_summary)
  UPDATE stripe_events SET processed_at = NOW() WHERE event_id = $1

services/ui_iot/routes/billing.py
  logger.warning("Failed to assign customer role to %s", user_id)

db/migrations/119_stripe_webhook_idempotency.sql
  CREATE TABLE IF NOT EXISTS stripe_events (
```

Phase 205 complete. Waiting for next instruction file before starting phase 206.
