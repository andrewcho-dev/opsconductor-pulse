Phases 208 and 209 are written and ready.

Phase 208 fixes the 192 failing unit tests. The root cause is that the FakePool's mock_conn returns None for every fetchrow() call, causing route handlers to raise 404s. The fix:
1. Promote FakeConn to a proper top-level class with configurable per-method responses
2. Expose mock_conn as a fixture so individual tests can call set_response()
3. Create tests/factories.py with realistic fake records (fake_tenant, fake_device, fake_device_plan, etc.)
4. Update failing test files to configure mock responses before each request

Phase 209 closes the Stripe idempotency race window. The current SELECT→INSERT pattern allows two concurrent requests for the same event_id to both pass the SELECT before either INSERT commits. The fix is a single atomic INSERT...ON CONFLICT DO NOTHING RETURNING event_id — if RETURNING gives None, we lost the race, skip processing immediately.

Start Phase 208 first. Read docs/cursor-prompts/phase208-unit-test-db-stubs/000-start.md then work through tasks 001 through 005 in order.

Write your completion report to docs/dialogue/20260220-000038-phase208-completion.md when done.
