# Phase 104 â€” API: duration_minutes in Alert Rule CRUD

## File to modify
`services/ui_iot/routes/alerts.py`

## Step 1: Read alerts.py

Read `services/ui_iot/routes/alerts.py` to find:
- The Pydantic model for alert rule creation/update (e.g. `AlertRuleCreate`, `AlertRuleUpdate`).
- The INSERT and UPDATE SQL for alert rules.
- The SELECT SQL that returns alert rules to the caller.

## Step 2: Add to Pydantic models

In `AlertRuleCreate` (and `AlertRuleUpdate` if it exists):

```python
from typing import Optional
from pydantic import BaseModel, Field, validator

class AlertRuleCreate(BaseModel):
    # ... existing fields ...
    duration_minutes: Optional[int] = Field(
        default=None,
        ge=1,
        description="Fire only after condition holds for this many minutes. NULL = instant.",
    )
```

## Step 3: Add to INSERT SQL

Find the INSERT for creating an alert rule. Add `duration_minutes` to the
column list and parameter list:

```sql
INSERT INTO alert_rules
  (tenant_id, device_id, metric_name, operator, threshold, severity, name, enabled, duration_minutes)
VALUES
  ($1, $2, $3, $4, $5, $6, $7, $8, $9)
RETURNING *
```

Pass `body.duration_minutes` as the 9th parameter.

## Step 4: Add to UPDATE SQL

Find the PATCH/PUT handler for updating an alert rule. Include `duration_minutes`
in the SET clause:

```sql
UPDATE alert_rules
SET name = $1,
    metric_name = $2,
    operator = $3,
    threshold = $4,
    severity = $5,
    enabled = $6,
    duration_minutes = $7
WHERE id = $8 AND tenant_id = $9
RETURNING *
```

## Step 5: Verify SELECT already returns duration_minutes

If the SELECT uses `SELECT *` or explicitly lists columns, ensure
`duration_minutes` is included. The column was added in migration 074, so
`SELECT *` will include it automatically.

## Step 6: OpenAPI sanity check

```bash
curl -s http://localhost:8000/openapi.json | \
  python3 -c "import sys,json; schema=json.load(sys.stdin); \
  print(json.dumps(schema['components']['schemas'].get('AlertRuleCreate',{}), indent=2))" \
  | grep duration
```

Expected: `duration_minutes` appears in the schema.
