# Phase 112 — MQTT Password File + Provisioning Integration

## Overview

The Mosquitto password file (`passwd`) stores hashed passwords.
Format (after `mosquitto_passwd` hashing):
```
username:$7$hash...
```

Two types of users:
1. `service:pulse` — platform service account (ingest_iot, ui_iot)
2. `device:{tenant_id}:{device_id}` — per-device accounts

## Step 1: Create initial passwd file with service account

```bash
# Create the passwd file with the platform service account
# Using the MQTT_ADMIN_PASSWORD from .env
source compose/.env

docker run --rm -v $(pwd)/compose/mosquitto:/mosquitto/config \
  eclipse-mosquitto:2.0.18 \
  mosquitto_passwd -c -b /mosquitto/config/passwd \
  "service:pulse" "${MQTT_ADMIN_PASSWORD}"

echo "Passwd file created:"
cat compose/mosquitto/passwd
```

Add `compose/mosquitto/passwd` to `.gitignore` — it contains hashed passwords
that should not be committed:
```
compose/mosquitto/passwd
```

Create `compose/mosquitto/passwd.example` with a placeholder:
```
# MQTT password file — generated by mosquitto_passwd
# DO NOT commit the real passwd file.
# Generate with:
#   mosquitto_passwd -c -b passwd "service:pulse" "${MQTT_ADMIN_PASSWORD}"
#   mosquitto_passwd -b passwd "device:{tenant_id}:{device_id}" "${DEVICE_PASSWORD}"
```

## Step 2: Add MQTT credentials to platform service environment vars

In `compose/docker-compose.yml`, add MQTT credentials to services that
connect to the broker:

```yaml
  ingest:
    environment:
      MQTT_USERNAME: "service:pulse"
      MQTT_PASSWORD: ${MQTT_ADMIN_PASSWORD}
      MQTT_BROKER_URL: "mqtt://iot-mqtt:1883"  # internal plaintext (Docker network)

  ui:
    environment:
      MQTT_USERNAME: "service:pulse"
      MQTT_PASSWORD: ${MQTT_ADMIN_PASSWORD}
      MQTT_BROKER_URL: "mqtt://iot-mqtt:1883"
```

Internal services use port 1883 (plaintext, Docker network only).
External devices use port 8883 (TLS).

## Step 3: Update ingest_iot MQTT connection to use credentials

Read `services/ingest_iot/ingest.py` and find where the MQTT client connects
to the broker. Add username/password authentication:

```python
import os

MQTT_USERNAME = os.getenv("MQTT_USERNAME")
MQTT_PASSWORD = os.getenv("MQTT_PASSWORD")

# In the MQTT client setup / connect call:
if MQTT_USERNAME and MQTT_PASSWORD:
    client.username_pw_set(MQTT_USERNAME, MQTT_PASSWORD)
```

The exact location depends on which MQTT library is used (paho, aiomqtt, etc.).
Read the existing connect code and add credentials before the `connect()` call.

## Step 4: Update mqtt_sender.py in ui_iot to use credentials

Read `services/ui_iot/services/mqtt_sender.py`. In the `_publish_blocking()`
function, add authentication before `client.connect()`:

```python
mqtt_username = os.getenv("MQTT_USERNAME")
mqtt_password = os.getenv("MQTT_PASSWORD")

client = mqtt.Client()
if mqtt_username and mqtt_password:
    client.username_pw_set(mqtt_username, mqtt_password)
client.connect(host, port, keepalive=timeout)
```

## Step 5: Provisioning — add device to passwd file

When a new device is provisioned, its MQTT credentials must be added to the
passwd file. Find the provisioning endpoint in `services/provision_api/` or
`services/ui_iot/routes/devices.py`.

Add a call after device creation:

```python
import subprocess
import os

async def add_device_mqtt_credentials(tenant_id: str, device_id: str, password: str):
    """Add device MQTT user to Mosquitto password file."""
    username = f"device:{tenant_id}:{device_id}"
    passwd_file = os.getenv("MQTT_PASSWD_FILE", "/mosquitto/config/passwd")

    try:
        result = subprocess.run(
            ["mosquitto_passwd", "-b", passwd_file, username, password],
            capture_output=True, text=True, timeout=10,
        )
        if result.returncode != 0:
            raise RuntimeError(f"mosquitto_passwd failed: {result.stderr}")

        # Signal Mosquitto to reload the password file
        subprocess.run(["kill", "-HUP", "1"], capture_output=True)
    except Exception as exc:
        logger.warning("mqtt_passwd_add_failed",
                       extra={"device_id": device_id, "error": str(exc)})
        # Non-fatal — device can still use HTTP-only transport
```

**Important caveat:** The `passwd_file` path above only works if the
provisioning service runs inside the Mosquitto container or shares the volume.
For a proper multi-container setup, the passwd file must be on a shared volume
accessible to both the provisioning service and Mosquitto.

Update `docker-compose.yml` to mount the passwd volume into the provision_api
service:
```yaml
  api:
    volumes:
      - mosquitto-passwd:/mosquitto/config
```

And the mqtt service:
```yaml
  mqtt:
    volumes:
      - mosquitto-passwd:/mosquitto/config
```

Add `mosquitto-passwd` as a named volume.

**Alternative for production:** Use Mosquitto's dynamic security plugin
(`mosquitto-go-auth` or the built-in `plugin`) which reads credentials from
a database. This eliminates the shared-volume complexity. Defer to Phase 112b
if the shared-volume approach is sufficient for now.
