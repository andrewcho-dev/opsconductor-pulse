# Prompt 004 — Fix 422: Severity Tabs Must Filter Client-Side

## Problem

The backend `GET /customer/alerts` only accepts `status` values:
`OPEN | ACKNOWLEDGED | CLOSED | ALL`

The Phase 82 redesign is passing severity values (like `CRITICAL`, `HIGH`, or
`OPEN:CRITICAL`) as the `status` query param → 422 response.

## Fix

Read `frontend/src/features/alerts/AlertListPage.tsx` fully.

### Rule: status param sent to API is always one of the 4 valid values.
Severity filtering happens CLIENT-SIDE after the API response.

### Change the tab model:

```typescript
type TabKey = 'ALL' | 'OPEN' | 'CRITICAL' | 'HIGH' | 'MEDIUM' | 'LOW' | 'ACKNOWLEDGED' | 'CLOSED';

// Map each tab to the API status param and optional client-side severity filter
const TAB_CONFIG: Record<TabKey, { apiStatus: string; severity?: string }> = {
  ALL:          { apiStatus: 'ALL' },
  OPEN:         { apiStatus: 'OPEN' },
  CRITICAL:     { apiStatus: 'OPEN', severity: 'CRITICAL' },
  HIGH:         { apiStatus: 'OPEN', severity: 'HIGH' },
  MEDIUM:       { apiStatus: 'OPEN', severity: 'MEDIUM' },
  LOW:          { apiStatus: 'OPEN', severity: 'LOW' },
  ACKNOWLEDGED: { apiStatus: 'ACKNOWLEDGED' },
  CLOSED:       { apiStatus: 'CLOSED' },
};
```

### In the data fetch:
- Always send `status = TAB_CONFIG[activeTab].apiStatus` to the API
- After receiving results, if `TAB_CONFIG[activeTab].severity` is set,
  filter the alerts array client-side:
  ```typescript
  const filtered = TAB_CONFIG[activeTab].severity
    ? alerts.filter(a => a.severity === TAB_CONFIG[activeTab].severity)
    : alerts;
  ```

### Tab counts:
- For severity tabs (CRITICAL/HIGH/MEDIUM/LOW): fetch ALL OPEN alerts once
  (separate background query with limit=200) and count locally by severity
- Use `useQuery` with `queryKey: ['alert-counts']` and `staleTime: 30000`

```typescript
const { data: allOpenAlerts } = useQuery({
  queryKey: ['alert-counts'],
  queryFn: () => apiFetch('/customer/alerts?status=OPEN&limit=200'),
  staleTime: 30000,
});

const counts = {
  CRITICAL: allOpenAlerts?.alerts?.filter(a => a.severity === 'CRITICAL').length ?? 0,
  HIGH: allOpenAlerts?.alerts?.filter(a => a.severity === 'HIGH').length ?? 0,
  MEDIUM: allOpenAlerts?.alerts?.filter(a => a.severity === 'MEDIUM').length ?? 0,
  LOW: allOpenAlerts?.alerts?.filter(a => a.severity === 'LOW').length ?? 0,
};
```

### Tab display order:
ALL | Critical (n) | High (n) | Medium (n) | Low (n) | Ack'd | Closed

## Verify

```bash
cd frontend && npm run build 2>&1 | tail -10
```

Then in browser:
- Alerts page loads without 422
- All tabs show correct counts
- Clicking Critical tab shows only CRITICAL severity alerts
- Bulk actions still work

## Commit and push

```bash
git add -A
git commit -m "Fix alert inbox 422: severity tabs filter client-side, API always receives valid status"
git push origin main
git log --oneline -3
```
