<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Device {{ device_id }} - IoT Cloud Sim</title>
  <meta http-equiv="refresh" content="{{ refresh }}">
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; }
    a { color: #0b66c3; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; background:#fafafa; margin-right:6px; margin-bottom:6px; }
    .ONLINE { background: #eaffea; }
    .STALE { background: #fff1d6; }
    h2 { margin: 18px 0 8px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 6px 8px; font-size: 13px; }
    th { background: #f6f6f6; text-align: left; }
    .small { font-size:12px; color:#555; }
    .chartbox { border:1px solid #ddd; border-radius:10px; padding:10px; margin:10px 0; }
  </style>
</head>
<body>
  <div class="small"><a href="/">‚Üê Back to dashboard</a></div>
  <h1>Device {{ device_id }}</h1>
  <div class="small">Auto-refresh: {{ refresh }}s</div>

  {% if dev %}
    <div class="pill">Tenant: <b>{{ dev.tenant_id }}</b></div>
    <div class="pill">Site: <b>{{ dev.site_id }}</b></div>
    <div class="pill {{ dev.status }}">Status: <b>{{ dev.status }}</b></div>
    <div class="pill">Last Seen: <b>{{ dev.last_seen_at }}</b></div>
    <div class="pill">Battery: <b>{{ dev.battery_pct }}</b></div>
    <div class="pill">Temp: <b>{{ dev.temp_c }}</b></div>
    <div class="pill">RSSI: <b>{{ dev.rssi_dbm }}</b></div>
    <div class="pill">SNR: <b>{{ dev.snr_db }}</b></div>
  {% else %}
    <div class="small">No device_state row found yet for {{ device_id }}.</div>
  {% endif %}

  <h2>Charts (last ~120 accepted telemetry points)</h2>

  <div class="chartbox">
    <div class="small"><b>Battery%</b></div>
    <svg width="540" height="70">
      <polyline fill="none" stroke="#0b66c3" stroke-width="2" points="{{ charts.battery_pts }}"></polyline>
    </svg>
  </div>

  <div class="chartbox">
    <div class="small"><b>Temp C</b></div>
    <svg width="540" height="70">
      <polyline fill="none" stroke="#2a9d8f" stroke-width="2" points="{{ charts.temp_pts }}"></polyline>
    </svg>
  </div>

  <div class="chartbox">
    <div class="small"><b>RSSI (dBm)</b></div>
    <svg width="540" height="70">
      <polyline fill="none" stroke="#e76f51" stroke-width="2" points="{{ charts.rssi_pts }}"></polyline>
    </svg>
  </div>

  <h2>Last 200 Events (accepted + mirrored rejects)</h2>
  {% if events|length == 0 %}
    <div class="small">No events found.</div>
  {% else %}
  <table>
    <thead>
      <tr>
        <th>Ingested</th>
        <th>Accepted</th>
        <th>Tenant</th>
        <th>Site</th>
        <th>Type</th>
        <th>Reject Reason</th>
        <th>Token</th>
      </tr>
    </thead>
    <tbody>
      {% for e in events %}
      <tr>
        <td>{{ e.ingested_at }}</td>
        <td><b>{{ e.accepted }}</b></td>
        <td>{{ e.tenant_id }}</td>
        <td>{{ e.site_id }}</td>
        <td>{{ e.msg_type }}</td>
        <td>{{ e.reject_reason }}</td>
        <td>{{ e.token }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}
</body>
</html>
