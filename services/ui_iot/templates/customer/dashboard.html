{% extends "customer/base.html" %}

{% block title %}OpsConductor Pulse - Dashboard{% endblock %}

{% block head %}
<meta http-equiv="refresh" content="60">
<script src="/static/js/live_dashboard.js" defer></script>
{% endblock %}

{% block content %}
<div id="dashboard-page" data-ws-token="{{ ws_token }}">

<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
    <div></div>
    <div id="ws-status" class="ws-indicator disconnected">
        <span class="ws-dot"></span> Connecting...
    </div>
</div>

<div class="stats">
    <div class="stat-card">
        <div class="stat-value" id="stat-total">{{ device_counts.total }}</div>
        <div class="stat-label">Total Devices</div>
    </div>
    <div class="stat-card">
        <div class="stat-value status-online" id="stat-online">{{ device_counts.online }}</div>
        <div class="stat-label">Online</div>
    </div>
    <div class="stat-card">
        <div class="stat-value status-stale" id="stat-stale">{{ device_counts.stale }}</div>
        <div class="stat-label">Stale</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="alert-count">{{ alerts|length }}</div>
        <div class="stat-label">Open Alerts</div>
    </div>
</div>

<h2>Devices</h2>
<table>
    <thead>
        <tr>
            <th>Device ID</th>
            <th>Site</th>
            <th>Status</th>
            <th>Last Seen</th>
            <th>Battery</th>
        </tr>
    </thead>
    <tbody>
        {% for d in devices %}
        <tr>
            <td><a href="/customer/devices/{{ d.device_id }}">{{ d.device_id }}</a></td>
            <td>{{ d.site_id }}</td>
            <td class="status-{{ d.status|lower }}">{{ d.status }}</td>
            <td>{{ d.last_seen_at }}</td>
            <td>{{ d.battery_pct }}%</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<h2>Open Alerts <span class="small">(live via WebSocket)</span></h2>
<table>
    <thead>
        <tr>
            <th>Time</th>
            <th>Device</th>
            <th>Type</th>
            <th>Severity</th>
            <th>Summary</th>
        </tr>
    </thead>
    <tbody id="alert-tbody">
        {% for a in alerts %}
        <tr>
            <td>{{ a.created_at }}</td>
            <td>{{ a.device_id }}</td>
            <td>{{ a.alert_type }}</td>
            <td class="severity-{{ a.severity|lower }}">{{ a.severity }}</td>
            <td>{{ a.summary }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<h2>Recent Webhook Deliveries</h2>
<table>
    <thead>
        <tr>
            <th>Time</th>
            <th>Job</th>
            <th>Status</th>
            <th>HTTP</th>
            <th>Latency</th>
        </tr>
    </thead>
    <tbody>
        {% for d in delivery_attempts %}
        <tr>
            <td>{{ d.finished_at }}</td>
            <td>{{ d.job_id }}</td>
            <td>{% if d.ok %}OK{% else %}FAILED{% endif %}</td>
            <td>{{ d.http_status or '-' }}</td>
            <td>{{ d.latency_ms }}ms</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<p class="small">
    Stats refresh: 30s | Alerts: live via WebSocket | Fallback refresh: 60s |
    <a href="/customer/devices">All Devices</a> |
    <a href="/customer/alerts">All Alerts</a>
</p>

</div>
{% endblock %}
