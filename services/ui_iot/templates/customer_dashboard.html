<!DOCTYPE html>
<html>
<head>
    <title>OpsConductor Pulse - Dashboard</title>
    <meta http-equiv="refresh" content="{{ refresh }}">
    <style>
        body { font-family: monospace; margin: 20px; background: #1a1a2e; color: #eee; }
        .header { display: flex; justify-content: space-between; align-items: center; }
        .tenant-badge { background: #4a4a6a; padding: 4px 12px; border-radius: 4px; }
        .user-info { font-size: 0.9em; color: #aaa; margin-left: 8px; }
        .stats { display: flex; gap: 20px; margin: 20px 0; flex-wrap: wrap; }
        .stat-card { background: #2a2a4e; padding: 15px; border-radius: 8px; min-width: 140px; }
        .stat-value { font-size: 2em; font-weight: bold; }
        .stat-label { color: #888; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #333; }
        th { background: #2a2a4e; }
        .status-online { color: #4caf50; }
        .status-stale { color: #ff9800; }
        .severity-critical { color: #f44336; }
        .severity-warning { color: #ff9800; }
        .logout-btn { background: #4a4a6a; color: #fff; padding: 8px 16px;
                      text-decoration: none; border-radius: 4px; margin-left: 8px; }
        a { color: #8ab4f8; text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="header">
        <h1>OpsConductor Pulse</h1>
        <div>
            <span class="tenant-badge">Tenant: {{ tenant_id }}</span>
            {% if user and user.email %}
            <span class="user-info">{{ user.email }}</span>
            {% endif %}
            <a href="/logout" class="logout-btn">Logout</a>
        </div>
    </div>

    <div class="stats">
        <div class="stat-card">
            <div class="stat-value">{{ device_counts.total }}</div>
            <div class="stat-label">Total Devices</div>
        </div>
        <div class="stat-card">
            <div class="stat-value status-online">{{ device_counts.online }}</div>
            <div class="stat-label">Online</div>
        </div>
        <div class="stat-card">
            <div class="stat-value status-stale">{{ device_counts.stale }}</div>
            <div class="stat-label">Stale</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ alerts|length }}</div>
            <div class="stat-label">Open Alerts</div>
        </div>
    </div>

    <h2>Devices</h2>
    <table>
        <thead>
            <tr>
                <th>Device ID</th>
                <th>Site</th>
                <th>Status</th>
                <th>Last Seen</th>
                <th>Battery</th>
            </tr>
        </thead>
        <tbody>
            {% for d in devices %}
            <tr>
                <td><a href="/customer/devices/{{ d.device_id }}">{{ d.device_id }}</a></td>
                <td>{{ d.site_id }}</td>
                <td class="status-{{ d.status|lower }}">{{ d.status }}</td>
                <td>{{ d.last_seen_at }}</td>
                <td>{{ d.battery_pct }}%</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h2>Open Alerts</h2>
    <table>
        <thead>
            <tr>
                <th>Time</th>
                <th>Device</th>
                <th>Type</th>
                <th>Severity</th>
                <th>Summary</th>
            </tr>
        </thead>
        <tbody>
            {% for a in alerts %}
            <tr>
                <td>{{ a.created_at }}</td>
                <td>{{ a.device_id }}</td>
                <td>{{ a.alert_type }}</td>
                <td class="severity-{{ a.severity|lower }}">{{ a.severity }}</td>
                <td>{{ a.summary }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h2>Recent Webhook Deliveries</h2>
    <table>
        <thead>
            <tr>
                <th>Time</th>
                <th>Job</th>
                <th>Status</th>
                <th>HTTP</th>
                <th>Latency</th>
            </tr>
        </thead>
        <tbody>
            {% for d in delivery_attempts %}
            <tr>
                <td>{{ d.finished_at }}</td>
                <td>{{ d.job_id }}</td>
                <td>{% if d.ok %}OK{% else %}FAILED{% endif %}</td>
                <td>{{ d.http_status or '-' }}</td>
                <td>{{ d.latency_ms }}ms</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <p style="color: #666; font-size: 0.8em;">
        Auto-refresh: {{ refresh }}s |
        <a href="/customer/devices">All Devices</a> |
        <a href="/customer/alerts">All Alerts</a>
    </p>
    <script src="/static/js/auth.js"></script>
</body>
</html>
