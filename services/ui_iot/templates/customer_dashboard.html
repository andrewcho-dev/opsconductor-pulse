{% extends "customer/base.html" %}

{% block title %}OpsConductor Pulse - Dashboard{% endblock %}

{% block head %}
<meta http-equiv="refresh" content="{{ refresh }}">
{% endblock %}

{% block content %}
<div class="stats">
    <div class="stat-card">
        <div class="stat-value">{{ device_counts.total }}</div>
        <div class="stat-label">Total Devices</div>
    </div>
    <div class="stat-card">
        <div class="stat-value status-online">{{ device_counts.online }}</div>
        <div class="stat-label">Online</div>
    </div>
    <div class="stat-card">
        <div class="stat-value status-stale">{{ device_counts.stale }}</div>
        <div class="stat-label">Stale</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ alerts|length }}</div>
        <div class="stat-label">Open Alerts</div>
    </div>
</div>

<h2>Devices</h2>
<table>
    <thead>
        <tr>
            <th>Device ID</th>
            <th>Site</th>
            <th>Status</th>
            <th>Last Seen</th>
            <th>Battery</th>
        </tr>
    </thead>
    <tbody>
        {% for d in devices %}
        <tr>
            <td><a href="/customer/devices/{{ d.device_id }}">{{ d.device_id }}</a></td>
            <td>{{ d.site_id }}</td>
            <td class="status-{{ d.status|lower }}">{{ d.status }}</td>
            <td>{{ d.last_seen_at }}</td>
            <td>{{ d.battery_pct }}%</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<h2>Open Alerts</h2>
<table>
    <thead>
        <tr>
            <th>Time</th>
            <th>Device</th>
            <th>Type</th>
            <th>Severity</th>
            <th>Summary</th>
        </tr>
    </thead>
    <tbody>
        {% for a in alerts %}
        <tr>
            <td>{{ a.created_at }}</td>
            <td>{{ a.device_id }}</td>
            <td>{{ a.alert_type }}</td>
            <td class="severity-{{ a.severity|lower }}">{{ a.severity }}</td>
            <td>{{ a.summary }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<h2>Recent Webhook Deliveries</h2>
<table>
    <thead>
        <tr>
            <th>Time</th>
            <th>Job</th>
            <th>Status</th>
            <th>HTTP</th>
            <th>Latency</th>
        </tr>
    </thead>
    <tbody>
        {% for d in delivery_attempts %}
        <tr>
            <td>{{ d.finished_at }}</td>
            <td>{{ d.job_id }}</td>
            <td>{% if d.ok %}OK{% else %}FAILED{% endif %}</td>
            <td>{{ d.http_status or '-' }}</td>
            <td>{{ d.latency_ms }}ms</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<p style="color: #666; font-size: 0.8em;">
    Auto-refresh: {{ refresh }}s |
    <a href="/customer/devices">All Devices</a> |
    <a href="/customer/alerts">All Alerts</a>
</p>
{% endblock %}
