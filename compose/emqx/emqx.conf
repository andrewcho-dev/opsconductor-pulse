## EMQX Configuration for OpsConductor-Pulse
## Replaces Mosquitto — same ports, same TLS, same topic structure

node {
  name = "emqx@127.0.0.1"
  cookie = "${EMQX_NODE_COOKIE}"
  data_dir = "/opt/emqx/data"
}

## Map peer certificate CN to username (tenant_id/device_id)
mqtt {
  peer_cert_as_username = "cn"
}

## ─── LISTENERS ─────────────────────────────────────────

## Disable the default plain TCP listener to avoid port conflict.
listeners.tcp.default {
  enable = false
}

## Internal MQTT (password auth, service accounts) over TLS on 1883
listeners.ssl.internal {
  bind = "0.0.0.0:1883"
  max_connections = 1024
  enable_authn = true

  ssl_options {
    cacertfile = "/certs/ca.crt"
    certfile   = "/certs/server.crt"
    keyfile    = "/certs/server.key"
    verify     = verify_none
    versions   = ["tlsv1.2", "tlsv1.3"]
  }
}

## External MQTT (mutual TLS, device certificates)
listeners.ssl.default {
  bind = "0.0.0.0:8883"
  max_connections = 102400

  ssl_options {
    cacertfile = "/certs/combined-ca.crt"
    certfile   = "/certs/server.crt"
    keyfile    = "/certs/server.key"
    verify     = verify_peer
    fail_if_no_peer_cert = true
    versions   = ["tlsv1.2", "tlsv1.3"]
    enable_crl_check = true
  }

  ## Per-client publish rate limit
  messages_rate = "10/s"
  bytes_rate    = "100KB/s"
}

## WebSocket (password auth, browser clients)
listeners.ws.websocket {
  bind = "0.0.0.0:9001"
  max_connections = 1024
  websocket.mqtt_path = "/mqtt"
}

## ─── AUTHENTICATION ────────────────────────────────────

## Chain 1: Built-in password database (for service_pulse and internal accounts)
authentication = [
  {
    mechanism = password_based
    backend   = built_in_database
    user_id_type = username
  },
  {
    mechanism = password_based
    backend   = http
    method    = post
    url       = "http://iot-ui:8080/api/v1/internal/mqtt-auth"
    body {
      username   = "${username}"
      client_id  = "${clientid}"
      peer_cert_cn = "${cert_common_name}"
    }
    headers {
      "Content-Type" = "application/json"
      "X-Internal-Auth" = "${MQTT_INTERNAL_AUTH_SECRET}"
    }
    connect_timeout = "5s"
    request_timeout = "5s"
    pool_size = 8
  }
]

## ─── AUTHORIZATION (ACL) ───────────────────────────────

authorization {
  no_match = deny
  deny_action = disconnect

  sources = [
    {
      type = http
      enable = true
      method = post
      url = "http://iot-ui:8080/api/v1/internal/mqtt-acl"
      body {
        username = "${username}"
        topic    = "${topic}"
        action   = "${action}"
        client_id = "${clientid}"
      }
      headers {
        "Content-Type" = "application/json"
        "X-Internal-Auth" = "${MQTT_INTERNAL_AUTH_SECRET}"
      }
      connect_timeout = "5s"
      request_timeout = "5s"
      pool_size = 8
    }
  ]
}

## ─── DASHBOARD ─────────────────────────────────────────

dashboard {
  listeners.http {
    bind = "0.0.0.0:18083"
  }
  default_username = "admin"
  default_password = "${EMQX_DASHBOARD_PASSWORD}"
}

## ─── LOGGING ───────────────────────────────────────────

log {
  console {
    enable = true
    level  = warning
  }
}

