services:
  mqtt:
    image: emqx/emqx:5.8
    container_name: iot-mqtt
    environment:
      EMQX_NODE_COOKIE: "${EMQX_NODE_COOKIE:-emqx_pulse_secret}"
      EMQX_DASHBOARD_PASSWORD: "${EMQX_DASHBOARD_PASSWORD:-admin123}"
      MQTT_INTERNAL_AUTH_SECRET: "${MQTT_INTERNAL_AUTH_SECRET:-changeme_auth_secret}"
    ports:
      - "8883:8883"
      - "9001:9001"
      - "18083:18083"
    volumes:
      - ./emqx/emqx.conf:/opt/emqx/etc/emqx.conf:ro
      - ./mosquitto/certs:/certs:ro
      - emqx-data:/opt/emqx/data
    healthcheck:
      test: ["CMD", "emqx", "ctl", "status"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 15s
    restart: unless-stopped

  postgres:
    image: timescale/timescaledb@sha256:9e9f50161784dc57d3f547b89ded4af73553f9acb4677345ed05f45af7c7f664
    container_name: iot-postgres
    environment:
      POSTGRES_DB: iotcloud
      POSTGRES_USER: iot
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - "127.0.0.1:5432:5432"
    volumes:
      - ../data/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U iot -d iotcloud -h 127.0.0.1 -p 5432"]
      interval: 2s
      timeout: 3s
      retries: 30
      start_period: 5s
    restart: unless-stopped

  pgbouncer:
    image: edoburu/pgbouncer@sha256:85d1e38593617af1b5f7f285e97d407e56c29939683cc7cfe4c8f6dc19f1268b
    container_name: iot-pgbouncer
    environment:
      DATABASE_URL: "postgres://iot:${PG_PASS}@iot-postgres:5432/iotcloud"
      POOL_MODE: transaction
      MAX_CLIENT_CONN: 200
      DEFAULT_POOL_SIZE: 20
      MIN_POOL_SIZE: 5
      RESERVE_POOL_SIZE: 5
      RESERVE_POOL_TIMEOUT: 3
      SERVER_RESET_QUERY: DISCARD ALL
      LOG_CONNECTIONS: 0
      LOG_DISCONNECTIONS: 0
      AUTH_TYPE: scram-sha-256
    ports:
      - "127.0.0.1:6432:5432"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h 127.0.0.1 -p 5432"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  migrator:
    build:
      context: ../db
      dockerfile: Dockerfile.migrator
    container_name: iot-migrator
    environment:
      NOTIFY_DATABASE_URL: "postgresql://iot:${PG_PASS}@iot-postgres:5432/iotcloud"
      DATABASE_URL: "postgresql://iot:${PG_PASS}@iot-postgres:5432/iotcloud"
    depends_on:
      postgres:
        condition: service_healthy
    restart: "no"

  ingest:
    build:
      context: ../services
      dockerfile: ingest_iot/Dockerfile
    container_name: iot-ingest
    environment:
      SERVICE_NAME: ingest_iot
      MQTT_HOST: iot-mqtt
      MQTT_PORT: "1883"
      MQTT_USERNAME: "service_pulse"
      MQTT_PASSWORD: ${MQTT_ADMIN_PASSWORD}
      MQTT_CA_CERT: "/mosquitto/certs/ca.crt"
      MQTT_TLS_INSECURE: "true"
      MQTT_TOPIC: "tenant/+/device/+/+"
      PG_HOST: iot-pgbouncer
      PG_PORT: "5432"
      PG_DB: iotcloud
      PG_USER: iot
      PG_PASS: ${PG_PASS}
      DATABASE_URL: "postgresql://iot:${PG_PASS}@iot-pgbouncer:5432/iotcloud"
      # PG_POOL_MIN: "2"      # DB pool minimum connections (default: 2)
      # PG_POOL_MAX: "10"     # DB pool maximum connections (default: 10)
      # DELIVERY_WORKER_COUNT: "2"   # Async route delivery workers (default: 2)
      AUTO_PROVISION: "0"
      REQUIRE_TOKEN: "1"
      COUNTERS_ENABLED: "1"
      SETTINGS_POLL_SECONDS: "5"
      LOG_STATS_EVERY_SECONDS: "30"
      AUTH_CACHE_TTL_SECONDS: "${AUTH_CACHE_TTL_SECONDS:-60}"
      AUTH_CACHE_MAX_SIZE: "${AUTH_CACHE_MAX_SIZE:-10000}"
      BATCH_SIZE: "${BATCH_SIZE:-1000}"
      FLUSH_INTERVAL_MS: "${FLUSH_INTERVAL_MS:-500}"
      INGEST_WORKER_COUNT: "${INGEST_WORKER_COUNT:-8}"
      INGEST_QUEUE_SIZE: "${INGEST_QUEUE_SIZE:-100000}"
      CERT_AUTH_ENABLED: "1"
    volumes:
      - ./mosquitto/certs/ca.crt:/mosquitto/certs/ca.crt:ro
    expose:
      - "8080"
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; urllib.request.urlopen('http://localhost:8080/health', timeout=5)\" || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    depends_on:
      mqtt:
        condition: service_started
      postgres:
        condition: service_healthy
      pgbouncer:
        condition: service_healthy
      migrator:
        condition: service_completed_successfully
    restart: unless-stopped

  evaluator:
    build:
      context: ../services
      dockerfile: evaluator_iot/Dockerfile
    container_name: iot-evaluator
    environment:
      SERVICE_NAME: evaluator
      PG_HOST: iot-pgbouncer
      PG_PORT: "5432"
      PG_DB: iotcloud
      PG_USER: iot
      PG_PASS: ${PG_PASS}
      DATABASE_URL: "postgresql://iot:${PG_PASS}@iot-pgbouncer:5432/iotcloud"
      NOTIFY_DATABASE_URL: "postgresql://iot:${PG_PASS}@iot-postgres:5432/iotcloud"
      POLL_SECONDS: "5"
      HEARTBEAT_STALE_SECONDS: "30"
    expose:
      - "8080"
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; urllib.request.urlopen('http://localhost:8080/health', timeout=5)\" || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    depends_on:
      postgres:
        condition: service_healthy
      pgbouncer:
        condition: service_healthy
      migrator:
        condition: service_completed_successfully
    restart: unless-stopped

  ops_worker:
    build:
      context: ../services
      dockerfile: ops_worker/Dockerfile
    container_name: iot-ops-worker
    environment:
      SERVICE_NAME: ops_worker
      MQTT_BROKER_URL: "mqtt://iot-mqtt:1883"
      MQTT_USERNAME: "service_pulse"
      MQTT_PASSWORD: ${MQTT_ADMIN_PASSWORD}
      MQTT_CA_CERT: "/mosquitto/certs/ca.crt"
      MQTT_TLS_INSECURE: "true"
      PG_HOST: iot-pgbouncer
      PG_PORT: "5432"
      PG_DB: iotcloud
      PG_USER: iot
      PG_PASS: ${PG_PASS}
      DATABASE_URL: "postgresql://iot:${PG_PASS}@iot-pgbouncer:5432/iotcloud"
      HEALTH_CHECK_INTERVAL: "60"
      SYSTEM_ALERT_ENABLED: "true"
      METRICS_COLLECTION_INTERVAL: "5"
      INGEST_HEALTH_URL: "http://iot-ingest:8080"
      EVALUATOR_HEALTH_URL: "http://iot-evaluator:8080"
      DEVICE_CA_CERT_PATH: "/mosquitto/certs/device-ca.crt"
      DEVICE_CA_KEY_PATH: "/mosquitto/certs/device-ca.key"
      CRL_OUTPUT_PATH: "/certs/device-crl.pem"
      EMQX_API_URL: "http://iot-mqtt:18083"
      EMQX_API_USER: "admin"
      EMQX_DASHBOARD_PASSWORD: "${EMQX_DASHBOARD_PASSWORD:-admin123}"
      CERT_EXPIRY_WARNING_DAYS: "30"
    volumes:
      - ./mosquitto/certs/ca.crt:/mosquitto/certs/ca.crt:ro
      - export-data:/tmp/pulse-exports
      - ./mosquitto/certs:/mosquitto/certs
      - ./mosquitto/certs:/certs
    depends_on:
      postgres:
        condition: service_healthy
      pgbouncer:
        condition: service_healthy
      migrator:
        condition: service_completed_successfully
      ingest:
        condition: service_started
      evaluator:
        condition: service_started
    healthcheck:
      test: ["CMD", "python3", "-c", "import sys; sys.exit(0)"]
      interval: 60s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  subscription-worker:
    build:
      context: ../services
      dockerfile: subscription_worker/Dockerfile
    environment:
      DATABASE_URL: "postgresql://iot:${PG_PASS}@iot-pgbouncer:5432/iotcloud"
      WORKER_INTERVAL_SECONDS: "3600"
      # NOTIFICATION_WEBHOOK_URL: "https://your-webhook.example.com/notify"
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_FROM: ${SMTP_FROM:-noreply@pulse.local}
      SMTP_TLS: ${SMTP_TLS:-true}
    depends_on:
      postgres:
        condition: service_healthy
      pgbouncer:
        condition: service_healthy
      migrator:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "python3", "-c", "import sys; sys.exit(0)"]
      interval: 60s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  # Device simulator (500 devices) - opt-in via profile to avoid zombie traffic
  device_sim:
    build: ../simulator/device_sim_iot
    container_name: iot-device-sim
    profiles:
      - simulator
    environment:
      MQTT_HOST: iot-mqtt
      MQTT_PORT: "1883"
      TENANT_ID: tenant-a
      SITE_PREFIX: sim-site
      SITES_COUNT: "5"
      DEVICE_COUNT: "500"
      PROVISION_API_URL: "http://iot-api:8081"
      PROVISION_ADMIN_KEY: ${PROVISION_ADMIN_KEY}
      SENSOR_PROFILE_MIX: "temperature_sensor:20,door_sensor:10,energy_meter:10,pressure_sensor:10,motion_sensor:10,hvac_controller:10,water_meter:10,air_quality:5,vibration_sensor:10,gps_tracker:5"
      INTERVAL_JITTER_PCT: "0.1"
      BATTERY_FLOOR: "10"
      BATTERY_DRAIN_MEAN: "0.02"
      BATTERY_DRAIN_JITTER: "0.02"
      RECHARGE_CHANCE: "0.002"
      RECHARGE_BOOST_MIN: "5"
      RECHARGE_BOOST_MAX: "15"
      FAILURE_DOWNTIME_MIN_SECONDS: "30"
      FAILURE_DOWNTIME_MAX_SECONDS: "300"
      LOG_STATS_SECONDS: "30"
    depends_on:
      mqtt:
        condition: service_started
    restart: unless-stopped

  caddy:
    image: caddy@sha256:7f4c19ed8c32f961644681823de1a2fe5b74c84a45d0f3995286010c84b6c554
    container_name: iot-caddy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - ui
      - keycloak
    restart: unless-stopped

  ui:
    build: ../services/ui_iot
    container_name: iot-ui
    volumes:
      - ../frontend/dist:/app/spa:ro
      - ../services/shared:/app/shared:ro
      - ./mosquitto/certs:/mosquitto/certs:ro
      - export-data:/tmp/pulse-exports
    environment:
      SERVICE_NAME: ui_iot
      PG_HOST: iot-pgbouncer
      PG_PORT: "5432"
      PG_DB: iotcloud
      PG_USER: iot
      PG_PASS: ${PG_PASS}
      DATABASE_URL: "postgresql://iot:${PG_PASS}@iot-pgbouncer:5432/iotcloud"
      UI_REFRESH_SECONDS: "5"
      PROVISION_API_URL: "http://iot-api:8081"
      PROVISION_ADMIN_KEY: ${PROVISION_ADMIN_KEY}
      MODE: "${MODE:-DEV}"
      KEYCLOAK_URL: "${KEYCLOAK_URL:-http://localhost:8180}"
      KEYCLOAK_PUBLIC_URL: "${KEYCLOAK_URL}"
      KEYCLOAK_INTERNAL_URL: "http://pulse-keycloak:8080"
      KEYCLOAK_JWKS_URI: "http://pulse-keycloak:8080/realms/pulse/protocol/openid-connect/certs"
      KEYCLOAK_ADMIN_USERNAME: "${KEYCLOAK_ADMIN_USERNAME:-admin}"
      KEYCLOAK_ADMIN_PASSWORD: "${KEYCLOAK_ADMIN_PASSWORD}"
      VITE_KEYCLOAK_URL: "${KEYCLOAK_URL:-http://localhost:8180}"
      UI_BASE_URL: "${UI_BASE_URL}"
      MQTT_HOST: iot-mqtt
      MQTT_PORT: "1883"
      MQTT_USERNAME: "service_pulse"
      MQTT_PASSWORD: ${MQTT_ADMIN_PASSWORD}
      MQTT_BROKER_URL: "mqtt://iot-mqtt:1883"
      MQTT_CA_CERT: "/mosquitto/certs/ca.crt"
      MQTT_TLS_INSECURE: "true"
      MQTT_INTERNAL_AUTH_SECRET: "${MQTT_INTERNAL_AUTH_SECRET:-changeme_auth_secret}"
      INGEST_HEALTH_URL: "http://iot-ingest:8080"
      EVALUATOR_HEALTH_URL: "http://iot-evaluator:8080"
      METRICS_COLLECTION_INTERVAL: "5"
      AUTH_CACHE_TTL_SECONDS: "60"
      REQUIRE_TOKEN: "1"
      CORS_ALLOWED_ORIGINS: "${CORS_ALLOWED_ORIGINS:-*}"
      API_RATE_LIMIT: "${API_RATE_LIMIT:-100}"
      API_RATE_WINDOW_SECONDS: "${API_RATE_WINDOW_SECONDS:-60}"
      WS_POLL_SECONDS: "${WS_POLL_SECONDS:-5}"
      DEVICE_CA_CERT_PATH: "/mosquitto/certs/device-ca.crt"
      DEVICE_CA_KEY_PATH: "/mosquitto/certs/device-ca.key"
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
      STRIPE_PUBLISHABLE_KEY: ${STRIPE_PUBLISHABLE_KEY:-}
    expose:
      - "8080"
    depends_on:
      postgres:
        condition: service_healthy
      pgbouncer:
        condition: service_healthy
      migrator:
        condition: service_completed_successfully
      api:
        condition: service_started
      keycloak:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/healthz')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    restart: unless-stopped

  api:
    build:
      context: ../services
      dockerfile: provision_api/Dockerfile
    container_name: iot-api
    environment:
      PG_HOST: iot-pgbouncer
      PG_PORT: "5432"
      PG_DB: iotcloud
      PG_USER: iot
      PG_PASS: ${PG_PASS}
      DATABASE_URL: "postgresql://iot:${PG_PASS}@iot-pgbouncer:5432/iotcloud"
      ADMIN_KEY: ${ADMIN_KEY}
      ACTIVATION_TTL_MINUTES: "60"
      MQTT_PASSWD_FILE: "/mosquitto/passwd/passwd"
    ports:
      - "127.0.0.1:8081:8081"
    depends_on:
      postgres:
        condition: service_healthy
      pgbouncer:
        condition: service_healthy
      migrator:
        condition: service_completed_successfully
    volumes:
      - mosquitto-passwd:/mosquitto/passwd
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8081/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    restart: unless-stopped

  seed:
    image: python:3.11-slim
    working_dir: /app
    volumes:
      - ../scripts:/app/scripts:ro
    environment:
      PG_HOST: iot-postgres
      PG_PORT: "5432"
      PG_DB: iotcloud
      PG_USER: iot
      PG_PASS: ${PG_PASS}
    depends_on:
      - postgres
    command: >
      sh -c "pip install asyncpg httpx && python scripts/seed_demo_data.py"
    profiles:
      - seed

  simulator:
    image: python:3.11-slim
    working_dir: /app
    volumes:
      - ../scripts:/app/scripts:ro
    environment:
      INGEST_URL: "http://ui:8080"
      PG_HOST: iot-postgres
      PG_PORT: "5432"
      PG_DB: iotcloud
      PG_USER: iot
      PG_PASS: ${PG_PASS}
      NUM_DEVICES_PER_TENANT: "3"
      TELEMETRY_INTERVAL: "10"
      HEARTBEAT_INTERVAL: "30"
    depends_on:
      - ui
      - postgres
    command: >
      sh -c "pip install asyncpg httpx && python scripts/device_simulator.py"
    restart: unless-stopped
    profiles:
      - simulator

  webhook_receiver:
    build: ../services/webhook_receiver
    container_name: iot-webhook-receiver
    environment:
      PORT: "9999"
    ports:
      - "127.0.0.1:9999:9999"
    restart: unless-stopped

  keycloak:
    image: quay.io/keycloak/keycloak@sha256:09a381c715ab0b111835b70f2905955274843a219c6f27efb348e4d9f4086858
    container_name: pulse-keycloak
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN_USERNAME}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
      KC_DB: postgres
      KC_DB_URL: "jdbc:postgresql://iot-postgres:5432/keycloak_db"
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: ${KC_DB_USER_PASSWORD}
      KC_HOSTNAME: ${KC_HOSTNAME}
      # Force issuer/base URLs to match the public HTTPS origin, even when
      # Keycloak is accessed over http://pulse-keycloak:8080 on the Docker network.
      KC_HOSTNAME_URL: "${KEYCLOAK_URL}"
      KC_HOSTNAME_ADMIN_URL: "${KEYCLOAK_URL}"
      KC_HOSTNAME_STRICT: "false"
      KC_HTTP_ENABLED: "true"
      KC_PROXY_HEADERS: "xforwarded"
      KC_HEALTH_ENABLED: "true"
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_FROM: ${SMTP_FROM}
      SMTP_FROM_DISPLAY_NAME: ${SMTP_FROM_DISPLAY_NAME}
      SMTP_USERNAME: ${SMTP_USERNAME}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      SMTP_SSL: ${SMTP_SSL}
      SMTP_STARTTLS: ${SMTP_STARTTLS}
      KEYCLOAK_CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET}
    command: start --import-realm --features=organization
    volumes:
      - ./keycloak/realm-pulse.json:/opt/keycloak/data/import/realm-pulse.json
    expose:
      - "8080"
    depends_on:
      postgres:
        condition: service_healthy
      keycloak-db-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD-SHELL", "bash -lc 'exec 3<>/dev/tcp/localhost/9000; echo -e \"GET /health/ready HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n\" >&3; read -r line <&3; echo \"$$line\" | grep -q \"200\"'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  keycloak-db-init:
    image: timescale/timescaledb@sha256:9e9f50161784dc57d3f547b89ded4af73553f9acb4677345ed05f45af7c7f664
    container_name: iot-keycloak-db-init
    environment:
      PGPASSWORD: ${POSTGRES_PASSWORD}
      KC_DB_USER_PASSWORD: ${KC_DB_USER_PASSWORD}
    command: >
      bash -lc "psql -h iot-postgres -U iot -d postgres
      -c \"DO \\\$\\\$ BEGIN IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'keycloak') THEN CREATE USER keycloak WITH PASSWORD '${KC_DB_USER_PASSWORD}'; END IF; END \\\$\\\$;\"
      -c \"ALTER USER keycloak WITH PASSWORD '${KC_DB_USER_PASSWORD}';\" &&
      (psql -h iot-postgres -U iot -d postgres -tAc \"SELECT 1 FROM pg_database WHERE datname='keycloak_db'\" | grep -q 1 ||
       psql -h iot-postgres -U iot -d postgres -c \"CREATE DATABASE keycloak_db OWNER keycloak\") &&
      psql -h iot-postgres -U iot -d postgres -c \"GRANT ALL PRIVILEGES ON DATABASE keycloak_db TO keycloak;\""
    depends_on:
      postgres:
        condition: service_healthy
    restart: "no"

  mailpit:
    image: axllent/mailpit:latest
    container_name: iot-mailpit
    ports:
      - "8025:8025"
      - "1025:1025"
    profiles:
      - dev

  prometheus:
    image: prom/prometheus:v2.51.0
    container_name: pulse-prometheus
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/alert_rules.yml:/etc/prometheus/alert_rules.yml:ro
      - prometheus_data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.retention.time=15d"
      - "--web.enable-lifecycle"
      - "--web.console.libraries=/etc/prometheus/console_libraries"
      - "--web.console.templates=/etc/prometheus/consoles"
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    depends_on:
      - ui
      - ingest
      - evaluator
      - ops_worker
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - default

  grafana:
    image: grafana/grafana:10.4.1
    container_name: pulse-grafana
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
      - grafana_data:/var/lib/grafana
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_SERVER_HTTP_PORT: "3001"
      GF_SERVER_ROOT_URL: "http://localhost:3001"
      GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH: /var/lib/grafana/dashboards/api-overview.json
    ports:
      - "${GRAFANA_PORT:-3001}:3001"
    depends_on:
      - prometheus
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - default

volumes:
  caddy_data:
  caddy_config:
  emqx-data:
  export-data:
  mosquitto-data:
  mosquitto-passwd:
  prometheus_data:
  grafana_data:
