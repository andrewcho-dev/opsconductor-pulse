services:
  mqtt:
    image: eclipse-mosquitto:2.0
    container_name: iot-mqtt
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ../data/mosquitto/config:/mosquitto/config
      - ../data/mosquitto/data:/mosquitto/data
      - ../data/mosquitto/log:/mosquitto/log
    restart: unless-stopped

  postgres:
    image: timescale/timescaledb:latest-pg16
    container_name: iot-postgres
    environment:
      POSTGRES_DB: iotcloud
      POSTGRES_USER: iot
      POSTGRES_PASSWORD: iot_dev
    ports:
      - "5432:5432"
    volumes:
      - ../data/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U iot -d iotcloud -h 127.0.0.1 -p 5432"]
      interval: 2s
      timeout: 3s
      retries: 30
      start_period: 5s
    restart: unless-stopped

  pgbouncer:
    # 1.22.1 tag was removed from Docker Hub; keep pullable with latest.
    image: edoburu/pgbouncer:latest
    container_name: iot-pgbouncer
    environment:
      DATABASE_URL: "postgres://iot:iot_dev@iot-postgres:5432/iotcloud"
      POOL_MODE: transaction
      MAX_CLIENT_CONN: 200
      DEFAULT_POOL_SIZE: 20
      MIN_POOL_SIZE: 5
      RESERVE_POOL_SIZE: 5
      RESERVE_POOL_TIMEOUT: 3
      SERVER_RESET_QUERY: DISCARD ALL
      LOG_CONNECTIONS: 0
      LOG_DISCONNECTIONS: 0
      AUTH_TYPE: scram-sha-256
    ports:
      - "6432:5432"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h 127.0.0.1 -p 5432"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  ingest:
    build:
      context: ../services
      dockerfile: ingest_iot/Dockerfile
    container_name: iot-ingest
    environment:
      SERVICE_NAME: ingest_iot
      MQTT_HOST: iot-mqtt
      MQTT_PORT: "1883"
      MQTT_TOPIC: "tenant/+/device/+/+"
      PG_HOST: iot-pgbouncer
      PG_PORT: "5432"
      PG_DB: iotcloud
      PG_USER: iot
      PG_PASS: iot_dev
      DATABASE_URL: "postgresql://iot:iot_dev@iot-pgbouncer:5432/iotcloud"
      AUTO_PROVISION: "0"
      REQUIRE_TOKEN: "1"
      COUNTERS_ENABLED: "1"
      SETTINGS_POLL_SECONDS: "5"
      LOG_STATS_EVERY_SECONDS: "30"
      AUTH_CACHE_TTL_SECONDS: "${AUTH_CACHE_TTL_SECONDS:-60}"
      AUTH_CACHE_MAX_SIZE: "${AUTH_CACHE_MAX_SIZE:-10000}"
      BATCH_SIZE: "${BATCH_SIZE:-1000}"
      FLUSH_INTERVAL_MS: "${FLUSH_INTERVAL_MS:-500}"
      INGEST_WORKER_COUNT: "${INGEST_WORKER_COUNT:-8}"
      INGEST_QUEUE_SIZE: "${INGEST_QUEUE_SIZE:-100000}"
    expose:
      - "8080"
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; urllib.request.urlopen('http://localhost:8080/health', timeout=5)\" || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    depends_on:
      mqtt:
        condition: service_started
      postgres:
        condition: service_healthy
      pgbouncer:
        condition: service_healthy
    restart: unless-stopped

  evaluator:
    build:
      context: ../services
      dockerfile: evaluator_iot/Dockerfile
    container_name: iot-evaluator
    environment:
      SERVICE_NAME: evaluator
      PG_HOST: iot-pgbouncer
      PG_PORT: "5432"
      PG_DB: iotcloud
      PG_USER: iot
      PG_PASS: iot_dev
      DATABASE_URL: "postgresql://iot:iot_dev@iot-pgbouncer:5432/iotcloud"
      NOTIFY_DATABASE_URL: "postgresql://iot:iot_dev@iot-postgres:5432/iotcloud"
      POLL_SECONDS: "5"
      HEARTBEAT_STALE_SECONDS: "30"
    expose:
      - "8080"
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; urllib.request.urlopen('http://localhost:8080/health', timeout=5)\" || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    depends_on:
      postgres:
        condition: service_healthy
      pgbouncer:
        condition: service_healthy
    restart: unless-stopped

  dispatcher:
    build:
      context: ../services
      dockerfile: dispatcher/Dockerfile
    container_name: iot-dispatcher
    environment:
      SERVICE_NAME: dispatcher
      PG_HOST: iot-pgbouncer
      PG_PORT: "5432"
      PG_DB: iotcloud
      PG_USER: iot
      PG_PASS: iot_dev
      DATABASE_URL: "postgresql://iot:iot_dev@iot-pgbouncer:5432/iotcloud"
      NOTIFY_DATABASE_URL: "postgresql://iot:iot_dev@iot-postgres:5432/iotcloud"
      DISPATCH_POLL_SECONDS: "5"
      ALERT_LOOKBACK_MINUTES: "30"
      ALERT_LIMIT: "200"
      ROUTE_LIMIT: "500"
    expose:
      - "8080"
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; urllib.request.urlopen('http://localhost:8080/health', timeout=5)\" || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    depends_on:
      postgres:
        condition: service_healthy
      pgbouncer:
        condition: service_healthy
    restart: unless-stopped

  delivery_worker:
    build:
      context: ../services
      dockerfile: delivery_worker/Dockerfile
    container_name: iot-delivery-worker
    environment:
      SERVICE_NAME: delivery_worker
      PG_HOST: iot-pgbouncer
      PG_PORT: "5432"
      PG_DB: iotcloud
      PG_USER: iot
      PG_PASS: iot_dev
      DATABASE_URL: "postgresql://iot:iot_dev@iot-pgbouncer:5432/iotcloud"
      NOTIFY_DATABASE_URL: "postgresql://iot:iot_dev@iot-postgres:5432/iotcloud"
      MODE: "${MODE:-DEV}"
      WORKER_POLL_SECONDS: "2"
      WORKER_BATCH_SIZE: "10"
      WORKER_TIMEOUT_SECONDS: "30"
      WORKER_MAX_ATTEMPTS: "5"
      WORKER_BACKOFF_BASE_SECONDS: "30"
      WORKER_BACKOFF_MAX_SECONDS: "7200"
      STUCK_JOB_MINUTES: "5"
    expose:
      - "8080"
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; urllib.request.urlopen('http://localhost:8080/health', timeout=5)\" || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    depends_on:
      postgres:
        condition: service_healthy
      pgbouncer:
        condition: service_healthy
    restart: unless-stopped

  ops_worker:
    build:
      context: ../services
      dockerfile: ops_worker/Dockerfile
    container_name: iot-ops-worker
    environment:
      SERVICE_NAME: ops_worker
      PG_HOST: iot-pgbouncer
      PG_PORT: "5432"
      PG_DB: iotcloud
      PG_USER: iot
      PG_PASS: iot_dev
      DATABASE_URL: "postgresql://iot:iot_dev@iot-pgbouncer:5432/iotcloud"
      HEALTH_CHECK_INTERVAL: "60"
      SYSTEM_ALERT_ENABLED: "true"
      METRICS_COLLECTION_INTERVAL: "5"
      INGEST_HEALTH_URL: "http://iot-ingest:8080"
      EVALUATOR_HEALTH_URL: "http://iot-evaluator:8080"
      DISPATCHER_HEALTH_URL: "http://iot-dispatcher:8080"
      DELIVERY_HEALTH_URL: "http://iot-delivery-worker:8080"
    depends_on:
      postgres:
        condition: service_healthy
      pgbouncer:
        condition: service_healthy
      ingest:
        condition: service_started
      evaluator:
        condition: service_started
      dispatcher:
        condition: service_started
      delivery_worker:
        condition: service_started
    restart: unless-stopped

  subscription-worker:
    build:
      context: ../services/subscription_worker
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: postgresql://iot:iot_dev@postgres:5432/iotcloud
      WORKER_INTERVAL_SECONDS: "3600"
      # NOTIFICATION_WEBHOOK_URL: "https://your-webhook.example.com/notify"
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

  # Device simulator (500 devices) - opt-in via profile to avoid zombie traffic
  device_sim:
    build: ../simulator/device_sim_iot
    container_name: iot-device-sim
    profiles:
      - simulator
    environment:
      MQTT_HOST: iot-mqtt
      MQTT_PORT: "1883"
      TENANT_ID: tenant-a
      SITE_PREFIX: sim-site
      SITES_COUNT: "5"
      DEVICE_COUNT: "500"
      PROVISION_API_URL: "http://iot-api:8081"
      PROVISION_ADMIN_KEY: "change-me-now"
      SENSOR_PROFILE_MIX: "temperature_sensor:20,door_sensor:10,energy_meter:10,pressure_sensor:10,motion_sensor:10,hvac_controller:10,water_meter:10,air_quality:5,vibration_sensor:10,gps_tracker:5"
      INTERVAL_JITTER_PCT: "0.1"
      BATTERY_FLOOR: "10"
      BATTERY_DRAIN_MEAN: "0.02"
      BATTERY_DRAIN_JITTER: "0.02"
      RECHARGE_CHANCE: "0.002"
      RECHARGE_BOOST_MIN: "5"
      RECHARGE_BOOST_MAX: "15"
      FAILURE_DOWNTIME_MIN_SECONDS: "30"
      FAILURE_DOWNTIME_MAX_SECONDS: "300"
      LOG_STATS_SECONDS: "30"
    depends_on:
      mqtt:
        condition: service_started
    restart: unless-stopped

  caddy:
    image: caddy:2-alpine
    container_name: iot-caddy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - ui
      - keycloak
    restart: unless-stopped

  ui:
    build: ../services/ui_iot
    container_name: iot-ui
    volumes:
      - ../frontend/dist:/app/spa:ro
      - ../services/shared:/app/shared:ro
    environment:
      SERVICE_NAME: ui_iot
      PG_HOST: iot-pgbouncer
      PG_PORT: "5432"
      PG_DB: iotcloud
      PG_USER: iot
      PG_PASS: iot_dev
      DATABASE_URL: "postgresql://iot:iot_dev@iot-pgbouncer:5432/iotcloud"
      UI_REFRESH_SECONDS: "5"
      PROVISION_API_URL: "http://iot-api:8081"
      PROVISION_ADMIN_KEY: "change-me-now"
      MODE: "${MODE:-DEV}"
      KEYCLOAK_URL: "${KEYCLOAK_URL:-http://localhost:8180}"
      KEYCLOAK_PUBLIC_URL: "${KEYCLOAK_URL:-https://192.168.10.53}"
      KEYCLOAK_INTERNAL_URL: "http://pulse-keycloak:8080"
      KEYCLOAK_JWKS_URI: "http://pulse-keycloak:8080/realms/pulse/protocol/openid-connect/certs"
      KEYCLOAK_ADMIN_USERNAME: "${KEYCLOAK_ADMIN_USERNAME:-admin}"
      KEYCLOAK_ADMIN_PASSWORD: "${KEYCLOAK_ADMIN_PASSWORD:-admin_dev}"
      VITE_KEYCLOAK_URL: "${KEYCLOAK_URL:-http://localhost:8180}"
      UI_BASE_URL: "${UI_BASE_URL:-http://localhost:8080}"
      MQTT_HOST: iot-mqtt
      MQTT_PORT: "1883"
      INGEST_HEALTH_URL: "http://iot-ingest:8080"
      EVALUATOR_HEALTH_URL: "http://iot-evaluator:8080"
      DISPATCHER_HEALTH_URL: "http://iot-dispatcher:8080"
      DELIVERY_HEALTH_URL: "http://iot-delivery-worker:8080"
      METRICS_COLLECTION_INTERVAL: "5"
      AUTH_CACHE_TTL_SECONDS: "60"
      REQUIRE_TOKEN: "1"
      CORS_ALLOWED_ORIGINS: "${CORS_ALLOWED_ORIGINS:-*}"
      API_RATE_LIMIT: "${API_RATE_LIMIT:-100}"
      API_RATE_WINDOW_SECONDS: "${API_RATE_WINDOW_SECONDS:-60}"
      WS_POLL_SECONDS: "${WS_POLL_SECONDS:-5}"
    expose:
      - "8080"
    depends_on:
      postgres:
        condition: service_healthy
      pgbouncer:
        condition: service_healthy
      api:
        condition: service_started
    restart: unless-stopped

  api:
    build: ../services/provision_api
    container_name: iot-api
    environment:
      PG_HOST: iot-pgbouncer
      PG_PORT: "5432"
      PG_DB: iotcloud
      PG_USER: iot
      PG_PASS: iot_dev
      DATABASE_URL: "postgresql://iot:iot_dev@iot-pgbouncer:5432/iotcloud"
      ADMIN_KEY: "change-me-now"
      ACTIVATION_TTL_MINUTES: "60"
    ports:
      - "8081:8081"
    depends_on:
      postgres:
        condition: service_healthy
      pgbouncer:
        condition: service_healthy
    restart: unless-stopped

  seed:
    image: python:3.11-slim
    working_dir: /app
    volumes:
      - ../scripts:/app/scripts:ro
    environment:
      PG_HOST: iot-postgres
      PG_PORT: "5432"
      PG_DB: iotcloud
      PG_USER: iot
      PG_PASS: iot_dev
    depends_on:
      - postgres
    command: >
      sh -c "pip install asyncpg httpx && python scripts/seed_demo_data.py"
    profiles:
      - seed

  simulator:
    image: python:3.11-slim
    working_dir: /app
    volumes:
      - ../scripts:/app/scripts:ro
    environment:
      INGEST_URL: "http://ui:8080"
      PG_HOST: iot-postgres
      PG_PORT: "5432"
      PG_DB: iotcloud
      PG_USER: iot
      PG_PASS: iot_dev
      NUM_DEVICES_PER_TENANT: "3"
      TELEMETRY_INTERVAL: "10"
      HEARTBEAT_INTERVAL: "30"
    depends_on:
      - ui
      - postgres
    command: >
      sh -c "pip install asyncpg httpx && python scripts/device_simulator.py"
    restart: unless-stopped
    profiles:
      - simulator

  webhook_receiver:
    build: ../services/webhook_receiver
    container_name: iot-webhook-receiver
    environment:
      PORT: "9999"
    ports:
      - "9999:9999"
    restart: unless-stopped

  keycloak:
    image: quay.io/keycloak/keycloak:26.0
    container_name: pulse-keycloak
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin_dev
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://iot-postgres:5432/iotcloud
      KC_DB_USERNAME: iot
      KC_DB_PASSWORD: iot_dev
      KC_HOSTNAME: "192.168.10.53"
      KC_HOSTNAME_STRICT: "false"
      KC_HTTP_ENABLED: "true"
      KC_PROXY_HEADERS: "xforwarded"
    command: start-dev --import-realm --features=organization
    volumes:
      - ./keycloak/realm-pulse.json:/opt/keycloak/data/import/realm-pulse.json
    expose:
      - "8080"
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

volumes:
  caddy_data:
  caddy_config:
