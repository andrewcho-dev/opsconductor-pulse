services:
  mqtt:
    image: eclipse-mosquitto:2.0
    container_name: iot-mqtt
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ../data/mosquitto/config:/mosquitto/config
      - ../data/mosquitto/data:/mosquitto/data
      - ../data/mosquitto/log:/mosquitto/log
    restart: unless-stopped

  postgres:
    image: postgres:16
    container_name: iot-postgres
    environment:
      POSTGRES_DB: iotcloud
      POSTGRES_USER: iot
      POSTGRES_PASSWORD: iot_dev
    ports:
      - "5432:5432"
    volumes:
      - ../data/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U iot -d iotcloud -h 127.0.0.1 -p 5432"]
      interval: 2s
      timeout: 3s
      retries: 30
      start_period: 5s
    restart: unless-stopped

  influxdb:
    image: influxdb:3-core
    container_name: iot-influxdb
    environment:
      INFLUXDB3_HTTP_BIND_ADDR: "0.0.0.0:8181"
      INFLUXDB3_DB_DIR: /var/lib/influxdb3
      INFLUXDB3_NODE_IDENTIFIER_PREFIX: "iot-node"
      INFLUXDB3_OBJECT_STORE: "file"
      INFLUXDB3_AUTH_TOKEN: "${INFLUXDB_TOKEN:-influx-dev-token-change-me}"
    ports:
      - "8181:8181"
    volumes:
      - ../data/influxdb3:/var/lib/influxdb3:z
    command:
      - influxdb3
      - serve
      - --node-id
      - iot-node
      - --object-store
      - file
    healthcheck:
      test: ["CMD-SHELL", "curl -sf -H \"Authorization: Bearer $$INFLUXDB3_AUTH_TOKEN\" http://localhost:8181/health"]
      interval: 5s
      timeout: 5s
      retries: 12
      start_period: 10s
    restart: unless-stopped

  ingest:
    build: ../services/ingest_iot
    container_name: iot-ingest
    environment:
      MQTT_HOST: iot-mqtt
      MQTT_PORT: "1883"
      MQTT_TOPIC: "tenant/+/device/+/+"
      PG_HOST: iot-postgres
      PG_PORT: "5432"
      PG_DB: iotcloud
      PG_USER: iot
      PG_PASS: iot_dev
      AUTO_PROVISION: "0"
      REQUIRE_TOKEN: "1"
      COUNTERS_ENABLED: "1"
      SETTINGS_POLL_SECONDS: "5"
      LOG_STATS_EVERY_SECONDS: "30"
      INFLUXDB_URL: "http://iot-influxdb:8181"
      INFLUXDB_TOKEN: "${INFLUXDB_TOKEN:-influx-dev-token-change-me}"
      AUTH_CACHE_TTL_SECONDS: "${AUTH_CACHE_TTL_SECONDS:-60}"
      AUTH_CACHE_MAX_SIZE: "${AUTH_CACHE_MAX_SIZE:-10000}"
      INFLUX_BATCH_SIZE: "${INFLUX_BATCH_SIZE:-500}"
      INFLUX_FLUSH_INTERVAL_MS: "${INFLUX_FLUSH_INTERVAL_MS:-1000}"
      INGEST_WORKER_COUNT: "${INGEST_WORKER_COUNT:-4}"
      INGEST_QUEUE_SIZE: "${INGEST_QUEUE_SIZE:-50000}"
    depends_on:
      mqtt:
        condition: service_started
      postgres:
        condition: service_healthy
      influxdb:
        condition: service_healthy
    restart: unless-stopped

  evaluator:
    build: ../services/evaluator_iot
    container_name: iot-evaluator
    environment:
      PG_HOST: iot-postgres
      PG_PORT: "5432"
      PG_DB: iotcloud
      PG_USER: iot
      PG_PASS: iot_dev
      POLL_SECONDS: "5"
      HEARTBEAT_STALE_SECONDS: "30"
      INFLUXDB_URL: "http://iot-influxdb:8181"
      INFLUXDB_TOKEN: "${INFLUXDB_TOKEN:-influx-dev-token-change-me}"
    depends_on:
      postgres:
        condition: service_healthy
      influxdb:
        condition: service_healthy
    restart: unless-stopped

  dispatcher:
    build: ../services/dispatcher
    container_name: iot-dispatcher
    environment:
      PG_HOST: iot-postgres
      PG_PORT: "5432"
      PG_DB: iotcloud
      PG_USER: iot
      PG_PASS: iot_dev
      DISPATCH_POLL_SECONDS: "5"
      ALERT_LOOKBACK_MINUTES: "30"
      ALERT_LIMIT: "200"
      ROUTE_LIMIT: "500"
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

  delivery_worker:
    build: ../services/delivery_worker
    container_name: iot-delivery-worker
    environment:
      PG_HOST: iot-postgres
      PG_PORT: "5432"
      PG_DB: iotcloud
      PG_USER: iot
      PG_PASS: iot_dev
      MODE: "${MODE:-DEV}"
      WORKER_POLL_SECONDS: "2"
      WORKER_BATCH_SIZE: "10"
      WORKER_TIMEOUT_SECONDS: "30"
      WORKER_MAX_ATTEMPTS: "5"
      WORKER_BACKOFF_BASE_SECONDS: "30"
      WORKER_BACKOFF_MAX_SECONDS: "7200"
      STUCK_JOB_MINUTES: "5"
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

  device_sim:
    build: ../simulator/device_sim_iot
    container_name: iot-device-sim
    environment:
      MQTT_HOST: iot-mqtt
      MQTT_PORT: "1883"
      TENANT_ID: enabled
      SITE_ID: lab-1
      DEVICE_COUNT: "25"
      HEARTBEAT_SECONDS: "5"
      TELEMETRY_SECONDS: "10"
      UPLINK_DROP_PERIOD: "60"
      UPLINK_DROP_DURATION: "20"
      BATTERY_FLOOR: "10"
      DRAIN_PER_TELEM_MEAN: "0.02"
      DRAIN_PER_TELEM_JITTER: "0.02"
      RECHARGE_CHANCE_PER_TELEM: "0.002"
      RECHARGE_BOOST_MIN: "5"
      RECHARGE_BOOST_MAX: "15"
      SIM_EXTRA_METRICS: "${SIM_EXTRA_METRICS:-1}"
    depends_on:
      mqtt:
        condition: service_started
    restart: unless-stopped

  caddy:
    image: caddy:2-alpine
    container_name: iot-caddy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - ui
      - keycloak
    restart: unless-stopped

  ui:
    build: ../services/ui_iot
    container_name: iot-ui
    volumes:
      - ../frontend/dist:/app/spa:ro
      - ../services/shared:/app/shared:ro
    environment:
      PG_HOST: iot-postgres
      PG_PORT: "5432"
      PG_DB: iotcloud
      PG_USER: iot
      PG_PASS: iot_dev
      UI_REFRESH_SECONDS: "5"
      PROVISION_API_URL: "http://iot-api:8081"
      PROVISION_ADMIN_KEY: "change-me-now"
      MODE: "${MODE:-DEV}"
      KEYCLOAK_URL: "${KEYCLOAK_URL:-http://localhost:8180}"
      KEYCLOAK_PUBLIC_URL: "${KEYCLOAK_URL:-http://localhost:8180}"
      KEYCLOAK_INTERNAL_URL: "http://pulse-keycloak:8080"
      VITE_KEYCLOAK_URL: "${KEYCLOAK_URL:-http://localhost:8180}"
      UI_BASE_URL: "${UI_BASE_URL:-http://localhost:8080}"
      INFLUXDB_URL: "http://iot-influxdb:8181"
      INFLUXDB_TOKEN: "${INFLUXDB_TOKEN:-influx-dev-token-change-me}"
      AUTH_CACHE_TTL_SECONDS: "60"
      INFLUX_BATCH_SIZE: "500"
      INFLUX_FLUSH_INTERVAL_MS: "1000"
      REQUIRE_TOKEN: "1"
      CORS_ALLOWED_ORIGINS: "${CORS_ALLOWED_ORIGINS:-*}"
      API_RATE_LIMIT: "${API_RATE_LIMIT:-100}"
      API_RATE_WINDOW_SECONDS: "${API_RATE_WINDOW_SECONDS:-60}"
      WS_POLL_SECONDS: "${WS_POLL_SECONDS:-5}"
    expose:
      - "8080"
    depends_on:
      postgres:
        condition: service_healthy
      api:
        condition: service_started
      influxdb:
        condition: service_healthy
    restart: unless-stopped

  api:
    build: ../services/provision_api
    container_name: iot-api
    environment:
      PG_HOST: iot-postgres
      PG_PORT: "5432"
      PG_DB: iotcloud
      PG_USER: iot
      PG_PASS: iot_dev
      ADMIN_KEY: "change-me-now"
      ACTIVATION_TTL_MINUTES: "60"
      INFLUXDB_URL: "http://iot-influxdb:8181"
      INFLUXDB_TOKEN: "${INFLUXDB_TOKEN:-influx-dev-token-change-me}"
    ports:
      - "8081:8081"
    depends_on:
      postgres:
        condition: service_healthy
      influxdb:
        condition: service_healthy
    restart: unless-stopped

  seed:
    image: python:3.11-slim
    working_dir: /app
    volumes:
      - ../scripts:/app/scripts:ro
    environment:
      PG_HOST: iot-postgres
      PG_PORT: "5432"
      PG_DB: iotcloud
      PG_USER: iot
      PG_PASS: iot_dev
      INFLUXDB_URL: "http://iot-influxdb:8181"
      INFLUXDB_TOKEN: "${INFLUXDB_TOKEN:-influx-dev-token-change-me}"
    depends_on:
      - postgres
      - influxdb
    command: >
      sh -c "pip install asyncpg httpx && python scripts/seed_demo_data.py"
    profiles:
      - seed

  simulator:
    image: python:3.11-slim
    working_dir: /app
    volumes:
      - ../scripts:/app/scripts:ro
    environment:
      INGEST_URL: "http://ui:8080"
      PG_HOST: iot-postgres
      PG_PORT: "5432"
      PG_DB: iotcloud
      PG_USER: iot
      PG_PASS: iot_dev
      NUM_DEVICES_PER_TENANT: "3"
      TELEMETRY_INTERVAL: "10"
      HEARTBEAT_INTERVAL: "30"
    depends_on:
      - ui
      - postgres
    command: >
      sh -c "pip install asyncpg httpx && python scripts/device_simulator.py"
    restart: unless-stopped
    profiles:
      - simulator

  webhook_receiver:
    build: ../services/webhook_receiver
    container_name: iot-webhook-receiver
    environment:
      PORT: "9999"
    ports:
      - "9999:9999"
    restart: unless-stopped

  keycloak:
    image: quay.io/keycloak/keycloak:24.0
    container_name: pulse-keycloak
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin_dev
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://iot-postgres:5432/iotcloud
      KC_DB_USERNAME: iot
      KC_DB_PASSWORD: iot_dev
      KC_HOSTNAME_URL: ${KEYCLOAK_URL:-http://localhost:8180}
      KC_HOSTNAME_ADMIN_URL: ${KEYCLOAK_URL:-http://localhost:8180}
      KC_HOSTNAME_STRICT: "false"
      KC_HTTP_ENABLED: "true"
      KC_PROXY_HEADERS: "xforwarded"
    command: start-dev --import-realm
    volumes:
      - ./keycloak/realm-pulse.json:/opt/keycloak/data/import/realm-pulse.json
    expose:
      - "8080"
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

volumes:
  caddy_data:
  caddy_config:
