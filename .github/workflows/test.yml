name: Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r services/ui_iot/requirements.txt
          pip install -r requirements-test.txt

      - name: Run unit tests
        run: |
          mkdir -p test-results
          pytest -m unit -v --tb=short --cov=services/ui_iot --cov-fail-under=30 --junitxml=test-results/unit.xml

      - name: Upload unit test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: test-results/unit.xml

  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Run tests
        run: |
          mkdir -p test-results
          cd frontend
          npm run test:ci

      - name: Run coverage
        run: |
          mkdir -p test-results
          cd frontend
          npx vitest run --coverage --reporter=json --outputFile=../test-results/frontend-coverage.json

      - name: Verify frontend builds
        working-directory: frontend
        run: npm run build

      - name: TypeScript type check
        working-directory: frontend
        run: npx tsc --noEmit

      - name: Lint check
        working-directory: frontend
        run: npx eslint src/ --max-warnings=0

      - name: Upload frontend coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: test-results/frontend-coverage.json

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: iotcloud_test
          POSTGRES_USER: iot
          POSTGRES_PASSWORD: iot_dev
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U iot -d iotcloud_test"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 10

      keycloak:
        image: quay.io/keycloak/keycloak:24.0
        env:
          KEYCLOAK_ADMIN: admin
          KEYCLOAK_ADMIN_PASSWORD: admin_dev
          KC_DB: postgres
          KC_DB_URL: jdbc:postgresql://postgres:5432/iotcloud_test
          KC_DB_USERNAME: iot
          KC_DB_PASSWORD: iot_dev
          KC_HOSTNAME_URL: http://localhost:8180
          KC_HTTP_ENABLED: "true"
        ports:
          - 8180:8080
        options: >-
          --health-cmd "curl -sf http://localhost:8080/health/ready || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 30
          --health-start-period 60s

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r services/ui_iot/requirements.txt
          pip install -r requirements-test.txt

      - name: Wait for Keycloak
        run: |
          for i in $(seq 1 30); do
            curl -sf http://localhost:8180/realms/master && break
            echo "Waiting for Keycloak... ($i)"
            sleep 5
          done

      - name: Run database migrations
        run: |
          for f in db/migrations/*.sql; do
            PGPASSWORD=iot_dev psql -h localhost -U iot -d iotcloud_test -f "$f"
          done

      - name: Run integration tests with coverage
        env:
          KEYCLOAK_URL: http://localhost:8180
          TEST_DATABASE_URL: postgresql://iot:iot_dev@localhost:5432/iotcloud_test
        run: |
          mkdir -p test-results
          pytest -m integration -v --tb=short \
            --cov=services/ui_iot --cov=services/dispatcher --cov=services/delivery_worker \
            --cov-report=xml --cov-report=term-missing --cov-fail-under=55 \
            --junitxml=test-results/integration.xml

      - name: Enforce coverage thresholds
        run: python scripts/check_coverage.py

      - name: Coverage ratchet check
        run: python scripts/coverage_ratchet.py

      - name: Upload coverage
        if: always()
        uses: codecov/codecov-action@v4
        with:
          file: coverage.xml
          fail_ci_if_error: false

      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: test-results/integration.xml

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, frontend-tests]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r services/ui_iot/requirements.txt
          pip install -r requirements-test.txt
          playwright install chromium

      - name: Start services
        run: docker compose -f compose/docker-compose.yml up -d --wait

      - name: Wait for services
        run: |
          echo "Waiting for UI..."
          for i in $(seq 1 30); do
            curl -sf http://localhost:8080/healthz && break
            sleep 5
          done
          echo "Waiting for Keycloak..."
          for i in $(seq 1 30); do
            curl -sf http://localhost:8180/realms/pulse && break
            sleep 5
          done

      - name: Run E2E tests
        env:
          KEYCLOAK_URL: http://localhost:8180
          UI_BASE_URL: http://localhost:8080
          RUN_E2E: "1"
        run: |
          mkdir -p test-results
          pytest -m e2e -v --tb=short --junitxml=test-results/e2e.xml

      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: test-results/e2e.xml

      - name: Upload Playwright traces on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-traces
          path: test-results/

      - name: Collect container logs on failure
        if: failure()
        run: |
          docker compose -f compose/docker-compose.yml logs ui > test-results/ui.log 2>&1
          docker compose -f compose/docker-compose.yml logs keycloak > test-results/keycloak.log 2>&1

      - name: Upload container logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: container-logs
          path: test-results/*.log

      - name: Cleanup
        if: always()
        run: docker compose -f compose/docker-compose.yml down -v

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install linters
        run: pip install ruff mypy

      - name: Ruff check
        run: ruff check services/

      - name: Ruff format check
        run: ruff format --check services/

      - name: Type check (non-blocking)
        run: mypy services/ui_iot --ignore-missing-imports || true

  benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: [unit-tests, integration-tests]
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: iotcloud_test
          POSTGRES_USER: iot
          POSTGRES_PASSWORD: iot_dev
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U iot -d iotcloud_test"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 10

      keycloak:
        image: quay.io/keycloak/keycloak:24.0
        env:
          KEYCLOAK_ADMIN: admin
          KEYCLOAK_ADMIN_PASSWORD: admin_dev
          KC_DB: postgres
          KC_DB_URL: jdbc:postgresql://postgres:5432/iotcloud_test
          KC_DB_USERNAME: iot
          KC_DB_PASSWORD: iot_dev
          KC_HOSTNAME_URL: http://localhost:8180
          KC_HTTP_ENABLED: "true"
        ports:
          - 8180:8080
        options: >-
          --health-cmd "curl -sf http://localhost:8080/health/ready || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 30
          --health-start-period 60s

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r services/ui_iot/requirements.txt
          pip install -r requirements-test.txt

      - name: Run database migrations
        run: |
          for f in db/migrations/*.sql; do
            PGPASSWORD=iot_dev psql -h localhost -U iot -d iotcloud_test -f "$f"
          done

      - name: Run benchmarks
        env:
          KEYCLOAK_URL: http://localhost:8180
          TEST_DATABASE_URL: postgresql://iot:iot_dev@localhost:5432/iotcloud_test
        run: >
          pytest -m benchmark -v
          --benchmark-json=benchmark_results.json
          --benchmark-enable

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark_results.json
